---
title: "Class and QWL analysis"
author: "Jerzy Eisenberg-Guyot"
date: "1/15/2020"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    keep_md: true
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**To do**

* Test how results differ if use numemps variable to divide PBs and caps rather than wksup

* Decide on final set of variables and how we want to group them

**Questions**

* Should we change the reference class from workers to capitalists?

* Should we use numemps instead of wksup to divide PBs and caps? Also, review crosstabs of class and numemps in appendix.

* Which class X gender/race interactions do we want to include in the manuscript?

**Codebook for non-self-explanatory variables**

* Class variables:
    + explained in IJHS (2020) paper

* Health variables:
    + srh_bin: poor/fair vs good/vgood/excellent self-rated health
    + depress: whether respondent has ever been diagnosed by a healthcare professional with depression
    + mntlhlth: days of poor mental health in past 30 days

* QWL variables:
    +	wrktype	  :	Work arrangement at main job
    +	yearsjob	:	Time at current job
    +	waypaid	  :	How paid in main job
    +	wrksched	:	Usual work schedule
    +	moredays	:	Days per month r work extra hours
    +	mustwork	:	Mandatory to work extra hours
    +	chngtme	  :	How often r allowed change schedule
    +	wrkhome	  :	How often r works at home
    +	whywkhme	:	Usual reason r work at home
    +	famwkoff	:	How hard to take time off
    +	wkvsfam	  :	How often job interferes fam life
    +	famvswk	  :	How often fam life interfere job
    +	hrsrelax	:	Hours per day r have to relax
    +	secondwk	:	R has job other than main
    +	learnnew	:	Job requires r to learn new things
    +	workfast	:	Job requires r to work fast
    +	workdiff	:	R does numerous things on job
    +	lotofsay	:	R has lot of say in job
    +	wktopsat	:	Satisfaction comes from work
    +	overwork	:	R has too much work to do well
    +	knowwhat	:	R knows what's expected on job
    +	myskills	:	Job allows r use of skills
    +	respect	  :	R treated with respect at work
    +	trustman	:	R trust management at work
    +	safetywk	:	Worker safety priority at work
    +	safefrst	:	No shortcuts on worker safety
    +	teamsafe	:	Mgt and employees work together re safety
    +	safehlth	:	Safety and health condition good at work
    +	proudemp	:	R proud to work for employer
    +	prodctiv	:	Work conditions allow productivity
    +	wksmooth	:	Workplace runs in smooth manner
    +	trdunion	:	Workers need strong unions
    +	partteam	:	R work as part of a team
    +	wkdecide	:	How often r take part in decisions
    +	setthngs	:	How often r set way things done
    +	toofewwk	:	How often not enough staff
    +	promteok	:	Rs chances for promotion good
    +	opdevel	  :	Opportunity to develop my abilities
    +	hlpequip	:	Enough help and equip to ge the job done
    +	haveinfo	:	Enough info to get the job done
    +	wkfreedm	:	A lot of freedom to decide how to do job
    +	fringeok	:	Fringe benefits are good
    +	supcares	:	Supervisor concerned about welfare
    +	condemnd	:	R free from conflicting demands
    +	promtefr	:	Promotions are handled fairly
    +	cowrkint	:	Coworkers take a personal interest in r
    +	jobsecok	:	The job security is good
    +	suphelp	  :	Supervisor helpful to r in getting job done
    +	wrktime	  :	R has enough time to get the job done
    +	cowrkhlp	:	Coworkers can be relied on when r needs help
    +	trainops	:	R have the training opportunities
    +	manvsemp	:	Relations bw management and employees
    +	hvylift	  :	R do repeated lifting
    +	handmove	:	R perform forceful hand movements
    +	wkpraise	:	R is likely to be praised by supervisor
    +	wkbonus	  :	R is likely to get a bonus or pay increase
    +	fairearn	:	How fair is what r earn on the job
    +	rincblls	:	Income alone is enough
    +	laidoff	  :	R was laid off main job last year
    +	jobfind1	:	How easy for r to find a same job
    +	trynewjb	:	How likely r make effort for new job next year
    +	wkageism	:	R feels discriminated because of age
    +	wkracism	:	R feels discriminated because of race
    +	wksexism	:	R feels discriminated because of gender
    +	wkharsex	:	R sexually harassed on the job last 12 months
    +	wkharoth	:	R threatened on the job last 12 months
    +	health1	  :	Rs health in general
    +	physhlth	:	Days of poor physical health past 30 days
    +	mntlhlth	:	Days of poor mental health past 30 days
    +	hlthdays	:	Days of activity limitation past 30 days
    +	usedup	  :	How often during past month r felt used up
    +	backpain	:	R had back pain in the past 12 months
    +	painarms	:	R had pain in the arms in the past 12 months
    +	hurtatwk	:	Number of injuries on the job past 12 months
    +	spvtrfair	:	Supervisor is fair
    +	strredpg	:	Access to stress management
    +	phyeffrt	:	Rate physical effort
    +	slpprblm	:	Trouble sleeping last 12 months
    +	satjob1	  :	Job satisfaction in general
    +	knowschd	:	How far in advance know work schedule
    +	usetech	  :	Percentage of time use tech
    +	stress12	:	Stress management program last 12 months
    +	hyperten	:	Told have hypertension or high blood pressure
    +	arthrtis	:	Told have arthritis or rheumatism
    +	diabetes	:	Told have diabetes
    +	depress	  :	Told have depression
    +	weight	  :	R weighs how much
    +	height	  :	R is how tall
    +	ntwkhard	:	Past week not work hard enough
    +	misswork	:	Miss work for health past 30 days
    
```{r warning=FALSE, message=FALSE}
library(readstata13)
library(foreign)
library(tidyr)
library(dplyr)
library(survival)
library(knitr)
library(ggplot2)
library(kableExtra)
library(survey)
library(tableone)
library(RColorBrewer)
library(survey)
library(VIM)
library(mice)
library(parallel)
library(mitools)
library(viridis)
library(survminer)
library(gridExtra)
library(stringr)
library(rms)
library(patchwork) 
library(spatstat)
library(purrr)

#########load data, which is a subsetted version of the GSS cumulative file available at the GSS website that I converted from .dta to .csv using Stata 
#####
#
#drop survey-ballot d, which was a ballot in 2006 that lacked responses to QWL variables
#remove those who were not employed, as only employed respondents were asked the QWL variables - also remove those with NA wrkstat (n=9), since they weren't asked the QWL variables 
#remove ballot b in 2002, as class variables weren't asked of that ballot in that year
#remove 421 respondents who still have IAP in 2006 and 2014 for QWL variables, even after making appropriate sample restrictions - according to GSS helpdesk, they weren't administered the questions/didn't complete the survey ('breakoffs')
read.csv('GSS_02_06_10_14_18.csv') %>% 
  filter(ballot != "ballot d") %>%
  filter(wrkstat=="working fulltime" | wrkstat=="working parttime" | wrkstat=="temp not working") %>%
  filter(!(year==2002 & ballot=="ballot b")) %>%
  mutate_all(funs(ifelse(.=="DK" | .=="NO ANSWER" | .=="DONT KNOW" | .=="Not asked" | .=="IAP,DK,NA,uncodeable", NA, .))) %>%
  filter(is.na(respect) | respect!="IAP") -> dat #removing those with IAP for respect is sufficient since IAPs are the same across other QWL variables

#########code new variables and make sure other variables coded correctly and will be treated appropriately by MICE (e.g., no character vars)
######
#

dat %>% 
  mutate(educ = factor(ifelse(degree == "bachelor" | degree == "graduate", "College +", 
                              ifelse(degree== "high school", "HS", 
                                     ifelse(degree == "junior college", "JuCo", 
                                            ifelse(degree == "lt high school", "<HS", NA)))),
                       levels=c("<HS", "HS", "JuCo", "College +")), 
         age=ifelse(age=="89 or older", 89, as.numeric(as.character(age))),
         mntlhlth=as.numeric(as.character(mntlhlth)),
         physhlth=as.numeric(as.character(physhlth)),
         hlthdays=as.numeric(as.character(hlthdays)),
         moredays=as.numeric(as.character(moredays)),
         region = factor(ifelse(region == "new england" | region == "middle atlantic", "Northeast",
                                   ifelse(region == "e. sou. central" | region == "south atlantic" | region == "w. sou. central", "South",
                                          ifelse(region == "e. nor. central" | region == "w. nor. central", "Midwest", "West")))),
         marital_tri=as.factor(ifelse(marital=="married", "married",
                            ifelse(marital=="never married", "never married",
                                   ifelse(marital=="widowed" | marital=="divorced" | marital=="separated", "wid/div/sep", marital)))),
         srh_bin=as.factor(ifelse(health1 == "fair" | health1 == "poor", "poor/fair", "good/vgood/exc")), 
         race_poc=as.factor(ifelse(race=="white", "white", 
                         ifelse(race=="black" | race=="other", "poc", NA))),
         race=factor(race, levels=c("white", "black", "other")),
         sex=as.factor(sex),
         disc_haras=ifelse(wkageism=="yes" | wkracism=="yes" | wksexism=="yes" | wkharsex=="yes" | wkharoth=="yes", 1, 0),
         disc_haras_unimp=disc_haras, #make duplicated version of each variable for which we wont impute data for so that we can use it in outcome regression
         respect_bin=ifelse(respect=="disagree" | respect=="strongly disagree", 1, 0),
         respect_bin_unimp=respect_bin,
         trustman_bin=ifelse(trustman=="disagree" | trustman=="strongly disagree", 1, 0),
         trustman_bin_unimp=trustman_bin,
         manvsemp_bin=ifelse(manvsemp=="quite bad" | manvsemp=="very bad", 1, 0),
         manvsemp_bin_unimp=manvsemp_bin,
         suphelp_bin=ifelse(suphelp=="not too true" | suphelp=="not at all true", 1, 0),
         suphelp_bin_unimp=suphelp_bin,
         supcares_bin=ifelse(supcares=="not too true" | supcares=="not at all true", 1, 0),
         supcares_bin_unimp=supcares_bin,
         wkfreedm_bin=ifelse(wkfreedm=="not too true" | wkfreedm=="not at all true", 1, 0),
         wkfreedm_bin_unimp=wkfreedm_bin,
         wkdecide_bin=ifelse(wkdecide=="rarely" | wkdecide=="never", 1, 0),
         wkdecide_bin_unimp=wkdecide_bin,
         safehlth_bin=ifelse(safehlth=="disagree" | safehlth=="strongly disagree", 1, 0),
         safehlth_bin_unimp=safehlth_bin,
         safetywk_bin=ifelse(safetywk=="disagree" | safetywk=="strongly disagree", 1, 0),
         safetywk_bin_unimp=safetywk_bin,
         mustwork_bin=ifelse(mustwork=="yes", 1, 0),
         mustwork_bin_unimp=mustwork_bin,
         famwkoff_bin=ifelse(famwkoff=="somewhat hard" | famwkoff=="very hard", 1, 0),
         famwkoff_bin_unimp=famwkoff_bin,
         wkvsfam_bin=ifelse(wkvsfam=="often" | wkvsfam=="sometimes", 1, 0),
         wkvsfam_bin_unimp=wkvsfam_bin,
         workfast_bin=ifelse(workfast=="agree" | workfast=="strongly agree", 1, 0),
         workfast_bin_unimp=workfast_bin,
         workdiff_bin=ifelse(workdiff=="disagree" | workdiff=="strongly disagree", 1, 0),
         workdiff_bin_unimp=workdiff_bin,
         overwork_bin=ifelse(overwork=="agree" | overwork=="strongly agree", 1, 0),
         overwork_bin_unimp=overwork_bin,
         wkpraise_bin=ifelse(wkpraise=="no", 1, 0),
         wkpraise_bin_unimp=wkpraise_bin,
         opdevel_bin=ifelse(opdevel=="not too true" | opdevel=="not at all true", 1, 0),
         opdevel_bin_unimp=opdevel_bin,
         wrktime_bin=ifelse(wrktime=="not too true" | wrktime=="not at all true", 1, 0),
         wrktime_bin_unimp=wrktime_bin,
         learnnew_bin=ifelse(learnnew=="disagree" | learnnew=="strongly disagree", 1, 0),
         learnnew_bin_unimp=learnnew_bin,
         condemnd_bin=ifelse(condemnd=="not too true" | condemnd=="not at all true", 1, 0),
         condemnd_bin_unimp=condemnd_bin,
         income=as.numeric(as.character(coninc)) * 251.1 / 172.2, #adjust income to 2018 dollars from 2000 dollars
         prestg10_bin=ifelse(prestg10 < weighted.median(prestg10, w=wtssall, na.rm=T), "low prestige", "high prestige"),  #prestige below median
         #we could also create the class variable using numemps (number of employees employed by the self-employed), but it's not available in 2002 
         class=factor(ifelse((wksup == "yes" & wrkslf == "self-employed") | (wksup == "yes" & wrkslf == "someone else" & occ10 == "chief executives"), "Capitalists", 
                              ifelse((wksup == "no" & wrkslf == "self-employed") | (wksup == "no" & wrkslf == "someone else" & occ10 == "chief executives"), "Petit bourgeoisie", 
                                                 ifelse(wksup == "yes" & wrkslf == "someone else" & occ10 != "chief executives", "Managers", 
                                                        ifelse(wksup == "no" & wrkslf ==  "someone else" & occ10 != "chief executives", "Workers", NA)))), 
                                   levels=c("Workers", "Managers", "Petit bourgeoisie", "Capitalists")),
         class_gender=factor(ifelse(class=="Workers" & sex=="male", "Male workers",
                                    ifelse(class=="Workers" & sex=="female", "Female workers",
                                           ifelse(class=="Managers" & sex=="male", "Male managers",
                                                  ifelse(class=="Managers" & sex=="female", "Female managers",
                                                         ifelse(class=="Petit bourgeoisie" & sex=="male", "Male petit bourgeoisie",
                                                                ifelse(class=="Petit bourgeoisie" & sex=="female", "Female petit bourgeoisie",
                                                                       ifelse(class=="Capitalists" & sex=="male", "Male capitalists",
                                                                              ifelse(class=="Capitalists" & sex=="female", "Female capitalists", NA)))))))),
                             levels=c("Male workers", "Male managers", "Male petit bourgeoisie", "Male capitalists",
                                      "Female workers", "Female managers", "Female petit bourgeoisie", "Female capitalists")),
         class_poc=factor(ifelse(class=="Workers" & race_poc=="white", "white workers",
                                    ifelse(class=="Workers" & race_poc=="poc", "poc workers",
                                           ifelse(class=="Managers" & race_poc=="white", "white managers",
                                                  ifelse(class=="Managers" & race_poc=="poc", "poc managers",
                                                         ifelse(class=="Petit bourgeoisie" & race_poc=="white", "white petit bourgeoisie",
                                                                ifelse(class=="Petit bourgeoisie" & race_poc=="poc", "poc petit bourgeoisie",
                                                                       ifelse(class=="Capitalists" & race_poc=="white", "white capitalists",
                                                                              ifelse(class=="Capitalists" & race_poc=="poc", "poc capitalists", NA)))))))),
                             levels=c("white workers", "white managers", "white petit bourgeoisie", "white capitalists",
                                      "poc workers", "poc managers", "poc petit bourgeoisie", "poc capitalists")),
         class_race=factor(ifelse(class=="Workers" & race=="white", "white workers",
                                    ifelse(class=="Workers" & race=="black", "black workers",
                                           ifelse(class=="Workers" & race=="other", "other workers",
                                                  ifelse(class=="Managers" & race=="white", "white managers",
                                                         ifelse(class=="Managers" & race=="black", "black managers",
                                                                ifelse(class=="Managers" & race=="other", "other managers",
                                                         ifelse(class=="Petit bourgeoisie" & race=="white", "white petit bourgeoisie",
                                                                ifelse(class=="Petit bourgeoisie" & race=="black", "black petit bourgeoisie",
                                                                       ifelse(class=="Petit bourgeoisie" & race=="other", "other petit bourgeoisie",
                                                                       ifelse(class=="Capitalists" & race=="white", "white capitalists",
                                                                              ifelse(class=="Capitalists" & race=="black", "black capitalists", 
                                                                                     ifelse(class=="Capitalists" & race=="other", "other capitalists", NA)))))))))))),
                             levels=c("white workers", "white managers", "white petit bourgeoisie", "white capitalists",
                                      "black workers", "black managers", "black petit bourgeoisie", "black capitalists",
                                      "other workers", "other managers", "other petit bourgeoisie", "other capitalists")),
         race_gender=factor(ifelse(race=="white" & sex=="male", "white male",
                                   ifelse(race=="white" & sex=="female", "white female",
                                          ifelse(race=="black" & sex=="male", "black male",
                                                 ifelse(race=="black" & sex=="female", "black female",
                                                        ifelse(race=="other" & sex=="male", "other male",
                                                               ifelse(race=="other" & sex=="female", "other female", NA)))))),
                            levels=c("white male", "white female", "black male", "black female", "other male", "other female"))) -> dat
```

# Confirming that class, race, and gender variables are coded correctly

```{r warning=FALSE, message=FALSE}
#class variable 
kable(table(dat$class, dat$wrkslf, dat$wksup, dat$occ10=="chief executives"), caption="Class by self employed by supervisor by chief executive", col.names=c("Class", "Self-employed", "Supervisor", "Chief executive", "Count")) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")

#class-gender variable 
kable(table(dat$class_gender, dat$sex), caption="Class-gender by gender", col.names=c("Class-gender", "Gender")) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")

#class-POC variable
kable(table(dat$class_poc, dat$race_poc), caption="Class-POC by POC") %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")

#class-race variable
kable(table(dat$class_race, dat$race), caption="Class-race by race") %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")

#race-gender variable
kable(table(dat$race_gender, dat$race, dat$sex), caption="Race-gender by race and gender", col.names=c("Race-gender", "Race", "Gender", "Count")) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")
```

# All QWL variables stratified by class (unweighted)

```{r warning=FALSE, message=FALSE}
dat %>%
  dplyr::select("class", "chngtme", "setthngs", "famwkoff", "wkvsfam", "famvswk", "wkdecide", "toofewwk",
                "learnnew", "workfast", "workdiff", "overwork", "knowwhat", "respect", "trustman",
                "safetywk", "safefrst", "teamsafe", "safehlth", "proudemp", "prodctiv", "wksmooth", 
                "trdunion", "lotofsay", "wktopsat", "myskills", "promteok", "opdevel", "hlpequip", "wkfreedm",
                "fringeok", "supcares", "condemnd", "cowrkint", "jobsecok", "suphelp", "wrktime", "cowrkhlp",
                "trainops", "manvsemp", "wkpraise", "wkbonus", "health1", "usedup", "knowschd", "stress12",
                "hyperten", "depress", "wrksched", "waypaid", "mustwork", "moredays", "partteam", "satjob1", 
                "rincblls", "laidoff", "jobfind1", "trynewjb", "hvylift", "handmove", "wkageism", "wkracism",
                "wksexism", "wkharsex", "wkharoth", "physhlth", "mntlhlth", "hlthdays", "backpain", "painarms", 
                "spvtrfair", "strredpg", "phyeffrt", "slpprblm") %>%
  mutate_at(vars(chngtme:setthngs), ~factor(., levels=c("IAP", "never", "rarely", "sometimes", "often"))) %>%
  mutate_at(vars(famwkoff), ~factor(., levels=c("not at all hard", "not too hard", "somewhat hard", "very hard"))) %>%
  mutate_at(vars(wkvsfam:toofewwk), ~factor(., levels=c("never", "rarely", "sometimes", "often"))) %>%
  mutate_at(vars(learnnew:trdunion), ~factor(., levels=c("strongly disagree", "disagree", "agree", "strongly agree"))) %>%
  mutate_at(vars(lotofsay:myskills), ~factor(., levels=c("IAP", "strongly disagree", "disagree", "agree", "strongly agree"))) %>%
  mutate_at(vars(promteok:cowrkhlp), ~factor(., levels=c("not at all true", "not too true", "somewhat true", "very true"))) %>%
  mutate_at(vars(trainops), ~factor(., levels=c("IAP", "not at all true", "not too true", "somewhat true", "very true"))) %>%
  mutate_at(vars(manvsemp), ~factor(., levels=c("very bad", "quite bad", "neither good nor bad", "quite good", "very good"))) %>%
  mutate_at(vars(wkpraise), ~factor(., levels=c("no", "maybe", "yes"))) %>%
  mutate_at(vars(wkbonus), ~factor(., levels=c("IAP", "no", "maybe", "yes"))) %>% 
  mutate_at(vars(health1), ~factor(., levels=c("poor", "fair", "good", "very good", "excellent"))) %>%
  mutate_at(vars(usedup), ~factor(., levels=c("never", "rarely", "sometimes", "often", "very often"))) %>%
  mutate_at(vars(knowschd), ~factor(., levels=c("IAP", "Don't know", "No answer", "one week or less", "between 1 and 2 weeks", "between 3 and 4 weeks", "4 weeks or more"))) %>%
  mutate_at(vars(stress12:depress), ~factor(., levels=c("IAP", "No answer", "no", "yes"))) -> dat_qwl

qwl_vars <- c("chngtme", "setthngs", "famwkoff", "wkvsfam", "famvswk", "wkdecide", "toofewwk",
                "learnnew", "workfast", "workdiff", "overwork", "knowwhat", "respect", "trustman",
                "safetywk", "safefrst", "teamsafe", "safehlth", "proudemp", "prodctiv", "wksmooth", 
                "trdunion", "lotofsay", "wktopsat", "myskills", "promteok", "opdevel", "hlpequip", "wkfreedm",
                "fringeok", "supcares", "condemnd", "cowrkint", "jobsecok", "suphelp", "wrktime", "cowrkhlp",
                "trainops", "manvsemp", "wkpraise", "wkbonus", "health1", "usedup", "knowschd", "stress12",
                "hyperten", "depress", "wrksched", "waypaid", "mustwork", "moredays", "partteam", "satjob1", 
                "rincblls", "laidoff", "jobfind1", "trynewjb", "hvylift", "handmove", "wkageism", "wkracism",
                "wksexism", "wkharsex", "wkharoth", "physhlth", "mntlhlth", "hlthdays", "backpain", "painarms", 
                "spvtrfair", "strredpg", "phyeffrt", "slpprblm")

qwl_vars_cat <- c("mustwork", "chngtme", "famwkoff", "wkvsfam", "famvswk", "secondwk", "learnnew",
                  "workfast", "workdiff", "lotofsay", "wktopsat", "overwork", "knowwhat", "myskills", "respect", "trustman", "safetywk",
                  "safefrst", "teamsafe", "safehlth", "proudemp", "prodctiv", "wksmooth", "trdunion", "partteam", "wkdecide", "setthngs",
                  "toofewwk", "promteok", "opdevel", "hlpequip", "haveinfo", "wkfreedm", "fringeok", "supcares", "condemnd", "promtefr",
                  "cowrkint", "jobsecok", "suphelp", "wrktime", "cowrkhlp", "trainops", "manvsemp", "hvylift", "handmove", "wkpraise",
                  "wkbonus", "rincblls", "laidoff", "jobfind1", "trynewjb", "wkageism", "wkracism", "wksexism", "wkharsex",
                  "wkharoth", "health1", "usedup",  "backpain", "painarms", "hurtatwk", "spvtrfair", "strredpg", "phyeffrt", "slpprblm",
                  "satjob1", "knowschd", "stress12", "hyperten", "depress", "waypaid", "wrksched")

x <- CreateTableOne(data = dat_qwl, vars = qwl_vars, factorVars=qwl_vars_cat, strata='class')
x <- print(x, printToggle=FALSE, noSpaces=TRUE)
kable(x[,1:4]) %>%
  kable_styling(c("striped", "condensed")) %>%
  scroll_box(width = "100%", height = "500px")
```

# Handling missing data

## Missingness patterns

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
aggr(dat[,c("wrkslf", "wksup", "class", 'sex', 'race', 'educ', 'marital_tri', 'region', 'income', 'age', "srh_bin", "mntlhlth", "learnnew_bin", "wkdecide_bin", "manvsemp_bin", "safehlth_bin", "workdiff_bin", "wkfreedm_bin", "trustman_bin", "safetywk_bin",  "workfast_bin", "respect_bin", "condemnd_bin", "disc_haras")], cex.axis = 0.6, numbers=FALSE, prop=TRUE)
```

## Multiple imputation

Remember to update number of imputations and cores for final analyses and to not use imputed values of dependent variables in outcome regressions.

```{r  warning=FALSE, message=FALSE, results='hide'}
#make imputation dataset
dat_mice <- dat[,c('sex', 'race', "race_poc", 'educ', 'year', 'marital_tri', 'region', 'income', 'age', "srh_bin", "mntlhlth", "learnnew_bin", "workdiff_bin",  "workfast_bin", "wkdecide_bin", "wkfreedm_bin",  "respect_bin", "manvsemp_bin", "trustman_bin", "condemnd_bin",  "safehlth_bin",  "safetywk_bin",  "disc_haras", "learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp", "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp", "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp", 'vpsu', 'vstrat', 'wtssall', "class", "class_gender", "class_poc", "class_race", "race_gender")]

#this creates an empty imputation object that you can manipulate and set options
initialize <- mice(dat_mice, max=0, print=FALSE)

#this creates an object that will contain the imputation method for each variable. let mice choose defaults based on variable class
method <- initialize$method 

#this code tells mice not to impute these variables: not imputing variables with complete data or the unimputed versions of the outcome variables
method[c("region", "race", "race_poc", "race_gender", "sex", "year", "vpsu", 'vstrat', 'wtssall', "learnnew_bin_unimp", "wkdecide_bin_unimp", "manvsemp_bin_unimp", "safehlth_bin_unimp", "workdiff_bin_unimp", "wkfreedm_bin_unimp", "trustman_bin_unimp", "safetywk_bin_unimp",  "workfast_bin_unimp", "respect_bin_unimp", "condemnd_bin_unimp", "disc_haras_unimp")] <- "" 

#passive imputation of variables that are perfect combos of other variables
method['class_gender'] <- "~ ifelse(class=='Workers' & sex=='male', 'Male workers',
                                    ifelse(class=='Workers' & sex=='female', 'Female workers',
                                           ifelse(class=='Managers' & sex=='male', 'Male managers',
                                                  ifelse(class=='Managers' & sex=='female', 'Female managers',
                                                         ifelse(class=='Petit bourgeoisie' & sex=='male', 'Male petit bourgeoisie',
                                                                ifelse(class=='Petit bourgeoisie' & sex=='female', 'Female petit bourgeoisie',
                                                                       ifelse(class=='Capitalists' & sex=='male', 'Male capitalists',
                                                                              ifelse(class=='Capitalists' & sex=='female', 'Female capitalists', NA))))))))"


method['class_poc'] <- "~ifelse(class=='Workers' & race_poc=='white', 'white workers',
                                    ifelse(class=='Workers' & race_poc=='poc', 'poc workers',
                                           ifelse(class=='Managers' & race_poc=='white', 'white managers',
                                                  ifelse(class=='Managers' & race_poc=='poc', 'poc managers',
                                                         ifelse(class=='Petit bourgeoisie' & race_poc=='white', 'white petit bourgeoisie',
                                                                ifelse(class=='Petit bourgeoisie' & race_poc=='poc', 'poc petit bourgeoisie',
                                                                       ifelse(class=='Capitalists' & race_poc=='white', 'white capitalists',
                                                                              ifelse(class=='Capitalists' & race_poc=='poc', 'poc capitalists', NA))))))))"

method['class_race'] <- "~ifelse(class=='Workers' & race=='white', 'white workers',
                                    ifelse(class=='Workers' & race=='black', 'black workers',
                                           ifelse(class=='Workers' & race=='other', 'other workers',
                                                  ifelse(class=='Managers' & race=='white', 'white managers',
                                                         ifelse(class=='Managers' & race=='black', 'black managers',
                                                                ifelse(class=='Managers' & race=='other', 'other managers',
                                                         ifelse(class=='Petit bourgeoisie' & race=='white', 'white petit bourgeoisie',
                                                                ifelse(class=='Petit bourgeoisie' & race=='black', 'black petit bourgeoisie',
                                                                       ifelse(class=='Petit bourgeoisie' & race=='other', 'other petit bourgeoisie',
                                                                       ifelse(class=='Capitalists' & race=='white', 'white capitalists',
                                                                              ifelse(class=='Capitalists' & race=='black', 'black capitalists', 
                                                                                     ifelse(class=='Capitalists' & race=='other', 'other capitalists', NA))))))))))))"

method['race_gender'] <- "~ifelse(race=='white' & sex=='male', 'white male',
                                   ifelse(race=='white' & sex=='female', 'white female',
                                          ifelse(race=='black' & sex=='male', 'black male',
                                                 ifelse(race=='black' & sex=='female', 'black female',
                                                        ifelse(race=='other' & sex=='male', 'other male',
                                                               ifelse(race=='other' & sex=='female', 'other female', NA))))))"

#this creates an object that will indicate which variables we actually want to include in predicting missing variables. 
prediction <- initialize$predictorMatrix  

#don't use interacted class-gender, class-race, and race-gender variables as predictors since they're collinear with uninteracted versions of those variables; don't use race_poc as predictor since it's collinear with race;  also don't use vstrat, since it has so many levels that models dont fit; don't use duplicated versions of dependent variables
prediction[,c("class_gender", "class_poc", "class_race", "race_gender", 'race_poc', 'vstrat', "learnnew_bin_unimp", "wkdecide_bin_unimp", "manvsemp_bin_unimp", "safehlth_bin_unimp", "workdiff_bin_unimp", "wkfreedm_bin_unimp", "trustman_bin_unimp", "safetywk_bin_unimp",  "workfast_bin_unimp", "respect_bin_unimp", "condemnd_bin_unimp", "disc_haras_unimp")] <- 0  

#set up parallel processing
cores_2_use <- 4 #4 cores times 5 imputations per core = 20 imputations
cl <- makeCluster(cores_2_use)
clusterSetRNGStream(cl, 9956)
clusterExport(cl, list("dat_mice", "method", "prediction"), envir=environment())
clusterEvalQ(cl, library(mice))
imp_pars <- 
  parLapply(cl = cl, X = 1:cores_2_use, fun = function(no){
    mice(dat_mice, m=5, meth=method, pred=prediction, print=FALSE, maxit = 25) #no seed because we don't want imputations to be identical across reps
  })
stopCluster(cl)

#combine the smaller imputation objects from each core into one imputation object
imp_merged <- imp_pars[[1]]
for (n in 2:length(imp_pars)){
  imp_merged <- 
    ibind(imp_merged,
          imp_pars[[n]])
}

#put data into usable format for survey package
imp.list <- lapply(1:20, function(x) mice::complete(imp_merged, x))
dat_mi <- imputationList(imp.list)
```

# Survey set the data

```{r warning=FALSE, message=FALSE}
#center data for the single-PSU stratum at the sample grand mean rather than the stratum mean (conservative)
options(survey.lonely.psu="adjust")

#make imputed survey design object
svy_dat_mi <- svydesign(ids = ~ vpsu,
                 strata = ~ vstrat, 
                 weights = ~ wtssall,
                 nest=TRUE, 
                 data=dat_mi)

#survey-set unimputed data for descriptives
svy_dat <- svydesign(ids = ~ vpsu,
                     strata = ~ vstrat,
                     weights = ~ wtssall, 
                     nest=TRUE, 
                     data=dat)
```

# Survey-weighted, unimputed descriptives

## Demographics and health stratifed by class 

```{r warning=FALSE, message=FALSE}
#vars of interest
vars <- c('sex', 'race', 'educ', 'marital_tri', 'region', 'income', 'age', "srh_bin", "mntlhlth")
nonorm <- c('income', 'age')

x <- svyCreateTableOne(data = svy_dat, vars = vars, strata='class')
x <- print(x, printToggle=FALSE, noSpaces=TRUE, nonnormal=nonorm)
kable(x[,1:4]) %>%
  kable_styling(c("striped", "condensed"))
```

## Select QWL variables stratified by class 

Unadjusted prevalence of bad category of each binary QWL variable among each class.

```{r warning=FALSE, message=FALSE}
#vars of interest
qwl_vars <- c("learnnew_bin", "workdiff_bin",  "workfast_bin", "wkdecide_bin", "wkfreedm_bin",  "respect_bin", "manvsemp_bin", "trustman_bin", "condemnd_bin",  "safehlth_bin",  "safetywk_bin", "disc_haras")

x <- svyCreateTableOne(data = svy_dat, vars = qwl_vars, factorVars=qwl_vars, strata='class')
x <- print(x, printToggle=FALSE, noSpaces=TRUE)
kable(x[,1:4]) %>%
  kable_styling(c("striped", "condensed"))
```

# Survey-weighted associations between select QWL variables and class from Poisson regressions

Restricted to intrinsically relational variables with potentially interesting differences across classes or races.

## Functions

```{r, message=FALSE, warning=FALSE}
#regression function
mysvy <- function(dat, columns, adjvars, ...){
  model <- lapply(as.list(columns), function(x){
    with(dat, svyglm(as.formula(paste0(names(dat$designs[[1]]$variables)[x], adjvars)), family=poisson(), ...))
  })
  return(model)
}

#regression matrix function
matrix_func <- function(nums, coefs, cols){
  regs_less = NULL
  for(i in 1:nums){
    exp(summary(MIcombine(less_adj[[i]]))[2:coefs,c(1,3,4)]) -> bind
    rbind(regs_less, cbind(bind, names(svy_dat_mi$designs[[1]]$variables)[cols][i])) -> regs_less
  }
  names(regs_less) <- c("PR", "Lower", "Upper", "Var")
  return(regs_less)
}

#format matrix function
formatted <- function(classvec, rows, qwlvec, dummy, facvec){
  as.data.frame(regs_less) %>%
    mutate(Class=rep(classvec, rows)) %>%
    bind_rows(data.frame(Var=qwlvec, 
                         Class=rep(dummy, rows), PR=rep(1, rows), Lower=rep(NA, rows), Upper=rep(NA, rows))) %>% #worker dummy row
    mutate(Class=factor(Class, levels=facvec),
           Var=factor(Var, levels=qwlvec),
           Cat=ifelse(Var=="learnnew_bin_unimp" | Var=="workdiff_bin_unimp" | Var == "workfast_bin_unimp", "Automation",
                      ifelse(Var=="wkdecide_bin_unimp" | Var=="wkfreedm_bin_unimp" | Var == "respect_bin_unimp", "Autonomy",
                             ifelse(Var=="manvsemp_bin_unimp" | Var=="trustman_bin_unimp" | Var == "condemnd_bin_unimp", "Conflict",
                                    ifelse(Var=="safehlth_bin_unimp" | Var=="safetywk_bin_unimp" | Var == "disc_haras_unimp", "Hazards", NA))))) -> binded
  return(binded)
}

#facet labeller function
facet_names <- list(
  "learnnew_bin_unimp"="Don't learn new things",
  "workdiff_bin_unimp"="Repetitive tasks",
  "workfast_bin_unimp"="Need to work fast", 
  "wkdecide_bin_unimp"="Don't make decisions", 
  "wkfreedm_bin_unimp"="No freedom on job", 
  "respect_bin_unimp"="Not treated with respect",
  "manvsemp_bin_unimp"="Worker-manager conflict", 
  "trustman_bin_unimp"="Don't trust management",
  "condemnd_bin_unimp"="Face conflicting demands", 
  "safehlth_bin_unimp"="Poor safety conditions",
  "safetywk_bin_unimp"="Safety not a priority",
  "disc_haras_unimp"="Face discrim. & harass."
)

facet_labeller <- function(variable,value){
  return(facet_names[value])
}

#plot function
plotted <- function(rows, xaxis, limitsvec, breaksvec, cols, shapes){
  xaxis <- enquo(xaxis)
  ggplot(binded[rows,], aes(x=!!xaxis, y=PR, ymin=Lower, ymax=Upper, shape=!!xaxis, color=!!xaxis)) +
    geom_hline(yintercept=1, lty=1, col='darkgrey') +
    geom_errorbar(width=0.5) +
    geom_point(size=2) +
    facet_wrap(~Var, ncol=1, labeller=facet_labeller) +
    scale_y_continuous(trans="log", limits=limitsvec, breaks=breaksvec, labels=scales::number_format(accuracy=0.01)) +
    theme_light() + 
    scale_color_manual(values=cols) +
    scale_shape_manual(values=shapes) +
    xlab('') +
    ylab("Prevalence ratio") +
    ggtitle(binded$Cat[rows]) +
    theme(strip.background = element_rect(fill=NA, color='grey'), strip.text = element_text(colour = "black"), 
          legend.position='none', axis.title.x = element_blank(), axis.text.x = element_blank(), 
          axis.ticks.x=element_blank(), plot.title = element_text(hjust = 0.5))
}

#legend function
legends <- function(rows, xaxis, cols, shapes, nrow=1){
  xaxis <- enquo(xaxis)
  leg <- ggplot(binded[rows,], aes(x=!!xaxis, y=PR, ymin=Lower, ymax=Upper, shape=!!xaxis, color=!!xaxis)) +
    geom_hline(yintercept=1, lty=1, col='darkgrey') +
    geom_errorbar(width=0.5) +
    geom_point(size=2) +
    facet_wrap(~Var, ncol=1) +
    theme_light() + 
    scale_color_manual(values=cols) +
    scale_shape_manual(values=shapes) +
    theme(legend.title=element_blank()) +
    guides(color=guide_legend(nrow=nrow, byrow=T, label.position="bottom", keywidth=7, keyheight=0.5)) 
  leg <- get_legend(leg)
  leg <- as_ggplot(leg)
}


#table function
tabled <- function(rows, captioned){
  kable(binded[rows,], digits=2, col.names=c("QWL variable", "Class", "PR", "Lower", "Upper", "Type"), caption=captioned) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")
}
```

## Class and QWL 

Prevalence of bad category of each binary QWL variable among each class relative to the prevalence among (all, white, or male) workers adjusted for age and year with restricted cubic splines.

### No interaction

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(svy_dat_mi, c(24:35), "~class + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(12, 4, c(24:35))

#format matrix
binded <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 12,
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "Workers",
                    c("Workers", "Managers", "Petite bourgeoisie", "Capitalists"))
```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=8}
#plot of estimates
(plotted(rows=c(1:9,37:39), xaxis=Class, limitsvec=c(0.049, 1.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
        cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18))  + 
  plotted(rows=c(10:18,40:42), xaxis=Class, limitsvec=c(0.049, 1.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(19:27,43:45), xaxis=Class, limitsvec=c(0.049, 1.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(28:36, 46:48), xaxis=Class, limitsvec=c(0.049, 1.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:9,37:39), xaxis=Class, cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18), nrow=1) +
  plot_layout(heights=c(1,0.1))

#table of estimates
tabled(1:36, "Ref: workers")
```

### Gender interaction

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(svy_dat_mi, c(24:35), "~class_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(12, 8, c(24:35))

#format matrix
binded <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists", "Female workers",
                      "Female managers", "Female petite bourgeoisie", "Female capitalists"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "Male workers",
                    c("Male workers", "Male managers", "Male petite bourgeoisie", "Male capitalists",
                      "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"))
```

```{r warning=FALSE, message=FALSE, fig.height=7, fig.width=9}
#plot of estimates
(plotted(rows=c(1:21,85:87), xaxis=Class, limitsvec=c(0.016, 2.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
        cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5))  + 
  plotted(rows=c(22:42,88:90), xaxis=Class, limitsvec=c(0.016, 2.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(43:63,91:93), xaxis=Class, limitsvec=c(0.016, 2.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(64:84,94:96), xaxis=Class, limitsvec=c(0.016, 2.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:21,85:87), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]),
          shapes=c(15,16,17,18,0,1,2,5), nrow=2) +
  plot_layout(heights=c(1,0.15))

#table of estimates
tabled(1:84, "Ref: male workers")
```

### Race interaction (white/POC)

Cell sizes too small among Black capitalists to divide up race variable even further. 

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(svy_dat_mi, c(24:35), "~class_poc + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(12, 8, c(24:35))

#format matrix
binded <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists", 
                      "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "White workers",
                    c("White workers", "White managers", "White petite bourgeoisie", "White capitalists", 
                      "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"))
```

```{r warning=FALSE, message=FALSE, fig.height=7, fig.width=9}
#plot of estimates
(plotted(rows=c(1:21,85:87), xaxis=Class, limitsvec=c(0.016, 3.24), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
        cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5))  + 
  plotted(rows=c(22:42,88:90), xaxis=Class, limitsvec=c(0.016, 3.24), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(43:63,91:93), xaxis=Class, limitsvec=c(0.016, 3.24), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(64:84,94:96), xaxis=Class, limitsvec=c(0.016, 3.24), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:21,85:87), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]),
          shapes=c(15,16,17,18,0,1,2,5), nrow=2) +
  plot_layout(heights=c(1,0.15))

#table of estimates
tabled(1:84, "Ref: white workers")
```

## Gender, race, and select QWL variables among workers

Prevalence of bad category of each binary QWL variable among each minoritized gender, racial, or gender-racial group of workers relative to the prevalence among male, white, or white male workers adjusted for age and year with restricted cubic splines.

### Gender

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(subset(svy_dat_mi, class=="Workers"), 24:35, "~relevel(as.factor(sex), ref='male') + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(12, 3, 24:35)

#for some reason function doesn't work properly when only extract one coefficient so we need to delete every other row from regs_less to get df formatted correctly
nth.delete <- function(dataframe, n)dataframe[-(seq(n,to=nrow(dataframe),by=n)),]
regs_less <- nth.delete(regs_less, 2)
  
#format matrix
binded <- formatted(c("Female"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "Male",
                    c("Male", "Female"))
```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=8}
#plot of estimates
(plotted(rows=c(1:3,13:15), xaxis=Class, limitsvec=c(0.71,1.57), breaksvec=c(0.75, 1, 1.3333333, 1.333333^2), 
        cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0))  + 
  plotted(rows=c(4:6,16:18), xaxis=Class, limitsvec=c(0.71,1.57), breaksvec=c(0.75, 1, 1.3333333, 1.333333^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(7:9,19:21), xaxis=Class, limitsvec=c(0.71,1.57), breaksvec=c(0.75, 1, 1.3333333, 1.333333^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(10:12,22:24), xaxis=Class, limitsvec=c(0.71,1.57), breaksvec=c(0.75, 1, 1.3333333, 1.333333^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1,13), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0), nrow=1) +
  plot_layout(heights=c(1,0.1))

#table of estimates
tabled(1:12, "Ref: male")
```

### Race

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(subset(svy_dat_mi, class=="Workers"), 24:35, "~race + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(12, 3, 24:35)
  
#format matrix
binded <- formatted(c("Black", "Other"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "White",
                    c("White", "Black", "Other"))
```

```{r warning=FALSE, message=FALSE, fig.height=7, fig.width=8}
#plot of estimates
(plotted(rows=c(1:6,25:27), xaxis=Class, limitsvec=c(0.39, 2.4), breaksvec=c(0.6, 1, 1.666667, 1.666667^2), 
        cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]), shapes=c(15, 0, 12))  + 
  plotted(rows=c(7:12,28:30), xaxis=Class, limitsvec=c(0.39, 2.4), breaksvec=c(0.6, 1, 1.666667, 1.666667^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]), shapes=c(15, 0, 12)) + 
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(13:18,31:33), xaxis=Class, limitsvec=c(0.39, 2.4), breaksvec=c(0.6, 1, 1.666667, 1.666667^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]), shapes=c(15, 0, 12)) +
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(19:24,34:36), xaxis=Class, limitsvec=c(0.39, 2.4), breaksvec=c(0.6, 1, 1.666667, 1.666667^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]), shapes=c(15, 0, 12)) + 
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:2,25), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]),
          shapes=c(15, 0, 12), nrow=1) +
  plot_layout(heights=c(1,0.1))

#table of estimates
tabled(1:24, "Ref: white")
```

### Gender-race interaction

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(subset(svy_dat_mi, class=="Workers"), 24:35, "~race_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(12, 6, 24:35)

#format matrix
binded <- formatted(c("White female", "Black male", "Black female", "Other male", "Other female"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                     "White male",
                    c("White male", "White female", "Black male", "Black female", "Other male", "Other female"))
```

```{r warning=FALSE, message=FALSE, fig.height=7, fig.width=9}
#plot estimates
(plotted(rows=c(1:15,61:63), xaxis=Class, limitsvec=c(0.1, 3.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
        cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]), shapes=c(15, 16, 0, 1, 12, 10))  + 
  plotted(rows=c(16:30,64:66), xaxis=Class, limitsvec=c(0.1, 3.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]), shapes=c(15, 16, 0, 1, 12, 10)) + 
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(31:45,67:69), xaxis=Class, limitsvec=c(0.1, 3.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]), shapes=c(15, 16, 0, 1, 12, 10)) +
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(46:60,70:72), xaxis=Class, limitsvec=c(0.1, 3.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]), shapes=c(15, 16, 0, 1, 12, 10)) + 
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:5,61), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]),
          shapes=c(15, 16, 0, 1, 12, 10), nrow=1) +
  plot_layout(heights=c(1,0.15))

#table of estimates
tabled(1:60, "Ref: white male")
```

# Appendix

## How many employees do PBs and capitalists typically identify as having? 

Note that the numemps variable wasn't asked in 2002, which is why we aren't using it for our primary analyses. Note also that numemps was only asked of people who identified as self-employed, which further supports our use of the self-employed variable to identify owners.

```{r, warning=FALSE, message=FALSE}
#run on unimputed data
dat %>%
  filter(year !=2002 & c(class=="Capitalists" | class=="Petit bourgeoisie")) %>%
  group_by(class) %>%
  summarise(mean_emps=round(mean(as.numeric(numemps), na.rm=T),1), 
            median_emps=round(median(as.numeric(numemps), na.rm=T),1),
            lower_IQR=round(quantile(as.numeric(numemps), 0.25, na.rm=T),1),
            upper_IQR=round(quantile(as.numeric(numemps), 0.75, na.rm=T),1),
            max=max(as.numeric(numemps), na.rm=T)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")
```

## How do more-adjusted regressions compare to less-adjusted regressions?

Adjusted for age, year, gender, race, education, region, and marital status.

### Class and QWL 

#### No interaction

```{r message=FALSE, warning=FALSE, results='hide'}
#run regression
less_adj <- mysvy(svy_dat_mi, c(24:35), "~class + rcs(age, 3) + rcs(year, 3) + race + sex + educ + region + marital_tri")

#pull into matrix
regs_less <- matrix_func(12, 4, c(24:35))

#format matrix
binded <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 12,
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "Workers",
                    c("Workers", "Managers", "Petite bourgeoisie", "Capitalists"))
```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=8}
#plot of estimates
(plotted(rows=c(1:9,37:39), xaxis=Class, limitsvec=c(0.049, 1.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
        cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18))  + 
  plotted(rows=c(10:18,40:42), xaxis=Class, limitsvec=c(0.049, 1.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(19:27,43:45), xaxis=Class, limitsvec=c(0.049, 1.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(28:36, 46:48), xaxis=Class, limitsvec=c(0.049, 1.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:9,37:39), xaxis=Class, cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18), nrow=1) +
  plot_layout(heights=c(1,0.1))

#table of estimates
tabled(1:36, "Ref: workers")
```

#### Gender interaction

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(svy_dat_mi, c(24:35), "~class_gender + rcs(age, 3) + rcs(year, 3) + race + educ + region + marital_tri")

#pull into matrix
regs_less <- matrix_func(12, 8, c(24:35))

#format matrix
binded <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists", "Female workers",
                      "Female managers", "Female petite bourgeoisie", "Female capitalists"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "Male workers",
                    c("Male workers", "Male managers", "Male petite bourgeoisie", "Male capitalists",
                      "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"))
```

```{r warning=FALSE, message=FALSE, fig.height=7, fig.width=9}
#plot of estimates
(plotted(rows=c(1:21,85:87), xaxis=Class, limitsvec=c(0.016, 2.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
        cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5))  + 
  plotted(rows=c(22:42,88:90), xaxis=Class, limitsvec=c(0.016, 2.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(43:63,91:93), xaxis=Class, limitsvec=c(0.016, 2.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(64:84,94:96), xaxis=Class, limitsvec=c(0.016, 2.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:21,85:87), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]),
          shapes=c(15,16,17,18,0,1,2,5), nrow=2) +
  plot_layout(heights=c(1,0.15))

#table of estimates
tabled(1:84, "Ref: male workers")
```

#### Race interaction (white/POC)

Cell sizes too small among Black capitalists to divide up race variable even further. 

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(svy_dat_mi, c(24:35), "~class_poc + rcs(age, 3) + rcs(year, 3) + sex + educ + region + marital_tri")

#pull into matrix
regs_less <- matrix_func(12, 8, c(24:35))

#format matrix
binded <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists", 
                      "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "White workers",
                    c("White workers", "White managers", "White petite bourgeoisie", "White capitalists", 
                      "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"))
```

```{r fig.height=7, fig.width=9, message=FALSE, warning=FALSE}
#plot of estimates
(plotted(rows=c(1:21,85:87), xaxis=Class, limitsvec=c(0.016, 3.24), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
        cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5))  + 
  plotted(rows=c(22:42,88:90), xaxis=Class, limitsvec=c(0.016, 3.24), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(43:63,91:93), xaxis=Class, limitsvec=c(0.016, 3.24), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(64:84,94:96), xaxis=Class, limitsvec=c(0.016, 3.24), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:21,85:87), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]),
          shapes=c(15,16,17,18,0,1,2,5), nrow=2) +
  plot_layout(heights=c(1,0.15))

#table of estimates
tabled(1:84, "Ref: white workers")
```

### Gender, race, and select QWL variables among workers

Prevalence of bad category of each binary QWL variable among each minoritized gender, racial, or gender-racial group of workers relative to the prevalence among male, white, or white male workers adjusted for age and year with restricted cubic splines.

#### Gender

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(subset(svy_dat_mi, class=="Workers"), 24:35, "~relevel(as.factor(sex), ref='male') + rcs(age, 3) + rcs(year, 3) + race + educ + region + marital_tri")

#pull into matrix
regs_less <- matrix_func(12, 3, 24:35)

#for some reason function doesn't work properly when only extract one coefficient so we need to delete every other row from regs_less to get df formatted correctly
nth.delete <- function(dataframe, n)dataframe[-(seq(n,to=nrow(dataframe),by=n)),]
regs_less <- nth.delete(regs_less, 2)
  
#format matrix
binded <- formatted(c("Female"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "Male",
                    c("Male", "Female"))
```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=8}
#plot of estimates
(plotted(rows=c(1:3,13:15), xaxis=Class, limitsvec=c(0.71,1.57), breaksvec=c(0.75, 1, 1.3333333, 1.333333^2), 
        cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0))  + 
  plotted(rows=c(4:6,16:18), xaxis=Class, limitsvec=c(0.71,1.57), breaksvec=c(0.75, 1, 1.3333333, 1.333333^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(7:9,19:21), xaxis=Class, limitsvec=c(0.71,1.57), breaksvec=c(0.75, 1, 1.3333333, 1.333333^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(10:12,22:24), xaxis=Class, limitsvec=c(0.71,1.57), breaksvec=c(0.75, 1, 1.3333333, 1.333333^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0)) + 
   theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1,13), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)]), shapes=c(15, 0), nrow=1) +
  plot_layout(heights=c(1,0.1))

#table of estimates
tabled(1:12, "Ref: male")
```

#### Race

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(subset(svy_dat_mi, class=="Workers"), 24:35, "~race + rcs(age, 3) + rcs(year, 3) + sex + educ + region + marital_tri")

#pull into matrix
regs_less <- matrix_func(12, 3, 24:35)
  
#format matrix
binded <- formatted(c("Black", "Other"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                    "White",
                    c("White", "Black", "Other"))
```

```{r warning=FALSE, message=FALSE, fig.height=7, fig.width=8}
#plot of estimates
(plotted(rows=c(1:6,25:27), xaxis=Class, limitsvec=c(0.39, 2.4), breaksvec=c(0.6, 1, 1.666667, 1.666667^2), 
        cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]), shapes=c(15, 0, 12))  + 
  plotted(rows=c(7:12,28:30), xaxis=Class, limitsvec=c(0.39, 2.4), breaksvec=c(0.6, 1, 1.666667, 1.666667^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]), shapes=c(15, 0, 12)) + 
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(13:18,31:33), xaxis=Class, limitsvec=c(0.39, 2.4), breaksvec=c(0.6, 1, 1.666667, 1.666667^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]), shapes=c(15, 0, 12)) +
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(19:24,34:36), xaxis=Class, limitsvec=c(0.39, 2.4), breaksvec=c(0.6, 1, 1.666667, 1.666667^2), 
          cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]), shapes=c(15, 0, 12)) + 
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:2,25), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(6)], brewer.pal(8, "Purples")[c(6)], brewer.pal(8, "Greens")[c(6)]),
          shapes=c(15, 0, 12), nrow=1) +
  plot_layout(heights=c(1,0.1))

#table of estimates
tabled(1:24, "Ref: white")
```

#### Gender-race interaction

```{r warning=FALSE, message=FALSE, results='hide'}
#run regression
less_adj <- mysvy(subset(svy_dat_mi, class=="Workers"), 24:35, "~race_gender + rcs(age, 3) + rcs(year, 3) + educ + region + marital_tri")

#pull into matrix
regs_less <- matrix_func(12, 6, 24:35)

#format matrix
binded <- formatted(c("White female", "Black male", "Black female", "Other male", "Other female"), 12, 
                    c("learnnew_bin_unimp", "workdiff_bin_unimp",  "workfast_bin_unimp", "wkdecide_bin_unimp",
                      "wkfreedm_bin_unimp",  "respect_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp",
                      "condemnd_bin_unimp",  "safehlth_bin_unimp",  "safetywk_bin_unimp",  "disc_haras_unimp"),
                     "White male",
                    c("White male", "White female", "Black male", "Black female", "Other male", "Other female"))
```

```{r warning=FALSE, message=FALSE, fig.height=7, fig.width=9}
#plot estimates
(plotted(rows=c(1:15,61:63), xaxis=Class, limitsvec=c(0.1, 3.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
        cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]), shapes=c(15, 16, 0, 1, 12, 10))  + 
  plotted(rows=c(16:30,64:66), xaxis=Class, limitsvec=c(0.1, 3.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]), shapes=c(15, 16, 0, 1, 12, 10)) + 
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(31:45,67:69), xaxis=Class, limitsvec=c(0.1, 3.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]), shapes=c(15, 16, 0, 1, 12, 10)) +
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plotted(rows=c(46:60,70:72), xaxis=Class, limitsvec=c(0.1, 3.07), breaksvec=c(0.125, 0.25, 0.5, 1, 2), 
          cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]), shapes=c(15, 16, 0, 1, 12, 10)) + 
    theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  plot_layout(ncol=4)) /
  legends(rows=c(1:5,61), xaxis=Class, cols=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)], brewer.pal(8, "Greens")[c(6,8)]),
          shapes=c(15, 16, 0, 1, 12, 10), nrow=1) +
  plot_layout(heights=c(1,0.15))

#table of estimates
tabled(1:60, "Ref: white male")
```

## Imputation convergence plots

```{r, warning=FALSE, message=FALSE}
plot(imp_merged, y=c('class', 'educ', 'marital_tri', 'income', 'age', "srh_bin", "mntlhlth", "learnnew_bin", "wkdecide_bin", "manvsemp_bin", "safehlth_bin", "workdiff_bin", "wkfreedm_bin", "trustman_bin", "safetywk_bin",  "workfast_bin", "respect_bin", "condemnd_bin", "disc_haras"), main='Convergence plots')
```
