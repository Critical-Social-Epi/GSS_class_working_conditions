---
title: "Class and Quality of Working Life (QWL)"
author: "Jerzy Eisenberg-Guyot"
date: "March, 2021"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    keep_md: true
always_allow_html: true
---

# Codebook for key variables

* Class variables:
    + workers: those who are not self-employed, who do not supervise others, and who are not chief executives
    + managers: those who are not self-employed, who do supervise others, and who are not chief executives
    + petit bourgeoisie: those who are self-employed and do not supervise others, or those who are chief executives and do not supervise others
    + capitalists: those who are self employed and do supervise others, or those who are chief executives and do supervise others

* Health variables:
    + srh_bin: poor/fair vs good/vgood/excellent self-rated health
    + mntlhlth: days of poor mental health in past 30 days

* QWL variables:
    +	mustwork	 :	Mandatory to work extra hours
    +	chngtme	   :	How often r allowed change schedule
    +	learnnew	 :	Job requires r to learn new things
    +	workfast	 :	Job requires r to work fast
    +	workdiff	 :	R does numerous things on job
    +	respect	   :	R treated with respect at work
    +	trustman	 :	R trust management at work
    +	safetywk	 :	Worker safety priority at work
    +	safehlth	 :	Safety and health condition good at work
    +	wkdecide	 :	How often r take part in decisions
    +	wkfreedm	 :	A lot of freedom to decide how to do job
    +	condemnd	 :	R free from conflicting demands
    +	manvsemp	 :	Relations bw management and employees
    +	rincblls	 :	Income alone is enough
    +	satjob1	   :	Job satisfaction in general
    + disc_haras :  Faced any discrimination or harassment on job

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE, message=FALSE}
library(readstata13)
library(foreign)
library(tidyr)
library(dplyr)
library(survival)
library(knitr)
library(ggplot2)
library(kableExtra)
library(survey)
library(tableone)
library(RColorBrewer)
library(survey)
library(VIM)
library(mice)
library(parallel)
library(mitools)
library(viridis)
library(survminer)
library(gridExtra)
library(stringr)
library(rms)
library(patchwork) 
library(spatstat)
library(purrr)

#########load data, which is a subsetted version of the GSS cumulative file available at the GSS website that I converted from .dta to .csv using Stata 
#####
#
#drop survey-ballot d, which was a ballot in 2006 that lacked responses to QWL variables
#remove those who were not employed, as only employed respondents were asked the QWL variables - also remove those with NA wrkstat (n=9), since they weren't asked the QWL variables 
#remove ballot b in 2002, as class variables weren't asked of that ballot in that year
#remove 421 respondents who still have IAP in 2006 and 2014 for QWL variables, even after making appropriate sample restrictions - according to GSS helpdesk, they weren't administered the questions/didn't complete the survey ('breakoffs')
read.csv('GSS_02_06_10_14_18.csv') %>% 
  filter(ballot != "ballot d") %>%
  filter(wrkstat=="working fulltime" | wrkstat=="working parttime" | wrkstat=="temp not working") %>%
  filter(!(year==2002 & ballot=="ballot b")) %>%
  mutate_all(funs(ifelse(.=="DK" | .=="NO ANSWER" | .=="DONT KNOW" | .=="Not asked" | .=="IAP,DK,NA,uncodeable" | .==".a", NA, .))) %>%
  filter(is.na(respect) | respect!="IAP") -> dat #removing those with IAP for respect is sufficient since IAPs are the same across other QWL variables

#########code new variables and make sure other variables coded correctly and will be treated appropriately by MICE (e.g., no character vars)
######
#

dat %>% 
  mutate(educ=factor(ifelse(degree == "bachelor" | degree == "graduate", "College +", 
                              ifelse(degree== "high school", "HS", 
                                     ifelse(degree == "junior college", "JuCo", 
                                            ifelse(degree == "lt high school", "<HS", NA)))),
                       levels=c("<HS", "HS", "JuCo", "College +")), 
         hispanic_bin=ifelse(hispanic=="not hispanic", 0, 1),
         race_h=factor(ifelse(race=="white" & hispanic_bin==0, "NH white",
                              ifelse(race=="black" & hispanic_bin==0, "NH Black",
                                     ifelse(race=="other" & hispanic_bin==0, "NH other",
                                            ifelse(hispanic_bin==1, "Hispanic", NA)))), levels=c("NH white", "NH Black", "NH other", "Hispanic")),
         poc=factor(ifelse(race_h=="NH white", "NH white",
                                  ifelse(race_h=="NH Black" | race_h=="Hispanic" | race_h=="NH other", "POC", NA)), levels=c("NH white", "POC")),
         age=ifelse(age=="89 or older", 89, as.numeric(as.character(age))),
         mntlhlth=as.numeric(as.character(mntlhlth)),
         physhlth=as.numeric(as.character(physhlth)),
         hlthdays=as.numeric(as.character(hlthdays)),
         moredays=as.numeric(as.character(moredays)),
         region = factor(ifelse(region == "new england" | region == "middle atlantic", "Northeast",
                                   ifelse(region == "e. sou. central" | region == "south atlantic" | region == "w. sou. central", "South",
                                          ifelse(region == "e. nor. central" | region == "w. nor. central", "Midwest", "West")))),
         marital_tri=as.factor(ifelse(marital=="married", "married",
                            ifelse(marital=="never married", "never married",
                                   ifelse(marital=="widowed" | marital=="divorced" | marital=="separated", "wid/div/sep", marital)))),
         srh_bin=as.factor(ifelse(health1 == "fair" | health1 == "poor", "poor/fair", "good/vgood/exc")), 
         sex=as.factor(sex),
         disc_haras_bin=ifelse(wkageism=="yes" | wkracism=="yes" | wksexism=="yes" | wkharsex=="yes" | wkharoth=="yes", 1, 0),
         disc_haras_bin_unimp=disc_haras_bin, #make duplicated version of each variable for which we wont impute data for so that we can use it in outcome regression
         respect_bin=ifelse(respect=="disagree" | respect=="strongly disagree", 1, 0),
         respect_bin_unimp=respect_bin,
         trustman_bin=ifelse(trustman=="disagree" | trustman=="strongly disagree", 1, 0),
         trustman_bin_unimp=trustman_bin,
         manvsemp_bin=ifelse(manvsemp=="quite bad" | manvsemp=="very bad", 1, 0),
         manvsemp_bin_unimp=manvsemp_bin,
         wkfreedm_bin=ifelse(wkfreedm=="not too true" | wkfreedm=="not at all true", 1, 0),
         wkfreedm_bin_unimp=wkfreedm_bin,
         wkdecide_bin=ifelse(wkdecide=="rarely" | wkdecide=="never", 1, 0),
         wkdecide_bin_unimp=wkdecide_bin,
         safehlth_bin=ifelse(safehlth=="disagree" | safehlth=="strongly disagree", 1, 0),
         safehlth_bin_unimp=safehlth_bin,
         safetywk_bin=ifelse(safetywk=="disagree" | safetywk=="strongly disagree", 1, 0),
         safetywk_bin_unimp=safetywk_bin,
         safefrst_bin=ifelse(safefrst=="disagree" | safefrst=="strongly disagree", 1, 0),
         safefrst_bin_unimp=safefrst_bin,
         mustwork_bin=ifelse(mustwork=="yes", 1, 0),
         mustwork_bin_unimp=mustwork_bin,
         workfast_bin=ifelse(workfast=="agree" | workfast=="strongly agree", 1, 0),
         workfast_bin_unimp=workfast_bin,
         workdiff_bin=ifelse(workdiff=="disagree" | workdiff=="strongly disagree", 1, 0),
         workdiff_bin_unimp=workdiff_bin,
         overwork_bin=ifelse(overwork=="agree" | overwork=="strongly agree", 1, 0),
         overwork_bin_unimp=overwork_bin,
         wrktime_bin=ifelse(wrktime=="not too true" | wrktime=="not at all true", 1, 0),
         wrktime_bin_unimp=wrktime_bin,
         learnnew_bin=ifelse(learnnew=="disagree" | learnnew=="strongly disagree", 1, 0),
         learnnew_bin_unimp=learnnew_bin,
         condemnd_bin=ifelse(condemnd=="not too true" | condemnd=="not at all true", 1, 0),
         condemnd_bin_unimp=condemnd_bin,
         knowschd_bin=ifelse(knowschd=="not too true" | knowschd=="not at all true", 1, 0),
         knowschd_bin_unimp=knowschd_bin,
         satjob1_bin=ifelse(satjob1=="not at all satisifed" | satjob1=="not too satisfied", 1, 0),
         satjob1_bin_unimp=satjob1_bin,
         rincblls_bin=ifelse(rincblls=="no", 1, 0),
         rincblls_bin_unimp=rincblls_bin,
         chngtme_bin=ifelse(chngtme=="IAP", NA, #chngtme not asked in 2018
                            ifelse(chngtme=="never" | chngtme=="rarely", 1, 0)),
         chngtme_bin_unimp=chngtme_bin,
         income=(as.numeric(as.character(coninc)) * 251.1 / 172.2)/10000, #adjust income to 2018 dollars from 2000 dollars (251.1 is CPI in 2018, 172.2 is CPI in 2000), then convert to $10,000s
         prestg10=as.numeric(prestg10),
         #we could also create the class variable using numemps (number of employees employed by the self-employed), but it's not available in 2002 
         class=factor(ifelse((wksup == "yes" & wrkslf == "self-employed") | (wksup == "yes" & wrkslf == "someone else" & occ10 == "chief executives"), "Capitalists", 
                              ifelse((wksup == "no" & wrkslf == "self-employed") | (wksup == "no" & wrkslf == "someone else" & occ10 == "chief executives"), "Petit bourgeoisie", 
                                                 ifelse(wksup == "yes" & wrkslf == "someone else" & occ10 != "chief executives", "Managers", 
                                                        ifelse(wksup == "no" & wrkslf ==  "someone else" & occ10 != "chief executives", "Workers", NA)))), 
                                   levels=c("Workers", "Managers", "Petit bourgeoisie", "Capitalists")),
         poc_gender=factor(ifelse(poc=="NH white" & sex=="male", "NH white men",
                                          ifelse(poc=="NH white" & sex=="female", "NH white women",
                                                 ifelse(poc=="POC" & sex=="male", "POC men",
                                                        ifelse(poc=="POC" & sex=="female", "POC women", NA)))),
                            levels=c("NH white men", "NH white women", "POC men", "POC women")),
         class_gender=factor(ifelse(class=="Workers" & sex=="male", "Male workers",
                                    ifelse(class=="Workers" & sex=="female", "Female workers",
                                           ifelse(class=="Managers" & sex=="male", "Male managers",
                                                  ifelse(class=="Managers" & sex=="female", "Female managers",
                                                         ifelse(class=="Petit bourgeoisie" & sex=="male", "Male petit bourgeoisie",
                                                                ifelse(class=="Petit bourgeoisie" & sex=="female", "Female petit bourgeoisie",
                                                                       ifelse(class=="Capitalists" & sex=="male", "Male capitalists",
                                                                              ifelse(class=="Capitalists" & sex=="female", "Female capitalists", NA)))))))),
                             levels=c("Male workers", "Male managers", "Male petit bourgeoisie", "Male capitalists",
                                      "Female workers", "Female managers", "Female petit bourgeoisie", "Female capitalists")),
         class_poc=factor(ifelse(class=="Workers" & poc=="NH white", "NH white workers",
                                    ifelse(class=="Workers" & poc=="POC", "POC workers",
                                           ifelse(class=="Managers" & poc=="NH white", "NH white managers",
                                                  ifelse(class=="Managers" & poc=="POC", "POC managers",
                                                         ifelse(class=="Petit bourgeoisie" & poc=="NH white", "NH white petit bourgeoisie",
                                                                ifelse(class=="Petit bourgeoisie" & poc=="POC", "POC petit bourgeoisie",
                                                                       ifelse(class=="Capitalists" & poc=="NH white", "NH white capitalists",
                                                                              ifelse(class=="Capitalists" & poc=="POC", "POC capitalists", NA)))))))),
                             levels=c("NH white workers", "NH white managers", "NH white petit bourgeoisie", "NH white capitalists",
                                      "POC workers", "POC managers", "POC petit bourgeoisie", "POC capitalists")),
         class_poc_gender=factor(ifelse(is.na(class_poc) | is.na(class_gender), NA, paste(class_poc, class_gender)))) -> dat
```

```{r  warning=FALSE, message=FALSE, results='hide'}
#make imputation dataset
dat_mice <- dat[,c('vpsu', 'vstrat', 'wtssall', 'year', 'age', 'sex', 'race_h', 'poc', "poc_gender", 'educ', 'region', 'marital_tri', 'income', "prestg10", "class", "class_gender", "class_poc", "class_poc_gender", "srh_bin", "mntlhlth", "satjob1_bin", "rincblls_bin", "safehlth_bin", "safetywk_bin", "workdiff_bin", "learnnew_bin", "condemnd_bin", "workfast_bin", "wkdecide_bin", "wkfreedm_bin", "mustwork_bin", "chngtme_bin", "manvsemp_bin", "trustman_bin", "respect_bin", "disc_haras_bin", "satjob1_bin_unimp", "rincblls_bin_unimp", "safehlth_bin_unimp", "safetywk_bin_unimp", "workdiff_bin_unimp", "learnnew_bin_unimp", "condemnd_bin_unimp", "workfast_bin_unimp", "wkdecide_bin_unimp", "wkfreedm_bin_unimp", "mustwork_bin_unimp", "chngtme_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp", "respect_bin_unimp", "disc_haras_bin_unimp")]

#this creates an empty imputation object that you can manipulate and set options
initialize <- mice(dat_mice, max=0, print=FALSE)

#this creates an object that will contain the imputation method for each variable. let mice choose defaults based on variable class
method <- initialize$method 

#this code tells mice not to impute these variables: not imputing variables with complete data or the unimputed versions of the outcome variables; don't impute chngtme_bin either, since it wasn't asked in 2018;  correlation with other variables should mitigate bias towards null
method[c("vpsu", 'vstrat', 'wtssall', "year", "sex", "region", "satjob1_bin_unimp", "rincblls_bin_unimp", "safehlth_bin_unimp", "safetywk_bin_unimp", "workdiff_bin_unimp", "learnnew_bin_unimp", "condemnd_bin_unimp", "workfast_bin_unimp", "wkdecide_bin_unimp", "wkfreedm_bin_unimp", "mustwork_bin_unimp", "chngtme_bin", "chngtme_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp", "respect_bin_unimp", "disc_haras_bin_unimp")] <- "" 

#use logistic models for imputed versions of outcome variables: default otherwise is pmm since I didn't code them as factor variables above
method[c("satjob1_bin", "rincblls_bin", "safehlth_bin", "safetywk_bin", "workdiff_bin", "learnnew_bin", "condemnd_bin", "workfast_bin", "wkdecide_bin", "wkfreedm_bin", "mustwork_bin", "manvsemp_bin", "trustman_bin", "respect_bin", "disc_haras_bin")] <- "logreg" 

#passive imputation of variables that are perfect combos of other variables; we transformed then imputed where we could (e.g., for the uninteracted class variable), but aren't with these variables to avoid collinearity/perfect-prediction issues; since there's so little missingness in the dataset anyways, the choice of transform-then-impute or impute-then-transform doesn't make much of a difference)

method['poc'] <- "~ifelse(race_h=='NH white', 'NH white',
                                  ifelse(race_h=='NH Black' | race_h=='Hispanic' | race_h=='NH other', 'POC', NA))"

method['poc_gender'] <- "~ifelse(poc=='NH white' & sex=='male', 'NH white men',
                                        ifelse(poc=='NH white' & sex=='female', 'NH white women',
                                               ifelse(poc=='POC' & sex=='male', 'POC men',
                                                      ifelse(poc=='POC' & sex=='female', 'POC women', NA))))"

method['class_gender'] <- "~ ifelse(class=='Workers' & sex=='male', 'Male workers',
                                    ifelse(class=='Workers' & sex=='female', 'Female workers',
                                           ifelse(class=='Managers' & sex=='male', 'Male managers',
                                                  ifelse(class=='Managers' & sex=='female', 'Female managers',
                                                         ifelse(class=='Petit bourgeoisie' & sex=='male', 'Male petit bourgeoisie',
                                                                ifelse(class=='Petit bourgeoisie' & sex=='female', 'Female petit bourgeoisie',
                                                                       ifelse(class=='Capitalists' & sex=='male', 'Male capitalists',
                                                                              ifelse(class=='Capitalists' & sex=='female', 'Female capitalists', NA))))))))"

method['class_poc'] <- "~ifelse(class=='Workers' & poc=='NH white', 'NH white workers',
                                    ifelse(class=='Workers' & poc=='POC', 'POC workers',
                                           ifelse(class=='Managers' & poc=='NH white', 'NH white managers',
                                                  ifelse(class=='Managers' & poc=='POC', 'POC managers',
                                                         ifelse(class=='Petit bourgeoisie' & poc=='NH white', 'NH white petit bourgeoisie',
                                                                ifelse(class=='Petit bourgeoisie' & poc=='POC', 'POC petit bourgeoisie',
                                                                       ifelse(class=='Capitalists' & poc=='NH white', 'NH white capitalists',
                                                                              ifelse(class=='Capitalists' & poc=='POC', 'POC capitalists', NA))))))))"

method['class_poc_gender'] <- "~ifelse(is.na(class_poc) | is.na(class_gender), NA, paste(class_poc, class_gender))"

#this creates an object that will indicate which variables we actually want to include in predicting missing variables. 
prediction <- initialize$predictorMatrix  

#in general, don't use uninteracted/less-interacted versions (poc, sex, class, poc_gender, class_poc, class_gender) of fully interacted variable (class_poc_gender) as predictors since they're collinear with fully-interacted variable; fully-interacted variable included over uninteracted/less-interacted variables per advice of MICE documentation; also don't use vstrat as a predictor, since it has so many levels that models dont fit; don't use duplicated versions of dependent variables; don't use chngtme_bin, since it wasn't asked in 2018
prediction[,c("race_h", "poc", "sex", "class", "poc_gender", "class_poc", "class_gender", 'vstrat', "satjob1_bin_unimp", "rincblls_bin_unimp", "safehlth_bin_unimp", "safetywk_bin_unimp", "workdiff_bin_unimp", "learnnew_bin_unimp", "condemnd_bin_unimp", "workfast_bin_unimp", "wkdecide_bin_unimp", "wkfreedm_bin_unimp", "mustwork_bin_unimp", "chngtme_bin", "chngtme_bin_unimp", "manvsemp_bin_unimp", "trustman_bin_unimp", "respect_bin_unimp", "disc_haras_bin_unimp")] <- 0

#when imputing race_h, i want gender and class as predictors (class_gender) but not class_poc_gender because of collinearity; don't need to do this for 'poc' because it's passively imputed
#when imputing class, i want gender and poc as predictors (poc_gender) but not class_poc_gender because of collinearity
#gender doesn't need imputing, interacted versions of variables are passively imputed
prediction[c("race_h"), "class_gender"] <- 1
prediction[c("race_h"), "class_poc_gender"] <- 0
prediction[c("class"), "poc_gender"] <- 1
prediction[c("class"), "class_poc_gender"] <- 0

#run MICE in parallel (4 cores * 5 imputations per core = 20 imputed datasets)
imp_merged <- parlmice(dat_mice, n.core=4, n.imp.core=5, meth=method, pred=prediction, maxit = 25, cluster.seed=9956) 

#put data into usable format for survey package
imp.list <- lapply(1:20, function(x) mice::complete(imp_merged, x))
dat_mi <- imputationList(imp.list)
```

```{r warning=FALSE, message=FALSE}
#center data for the single-PSU stratum at the sample grand mean rather than the stratum mean (conservative)
options(survey.lonely.psu="adjust")

#make imputed survey design object
svy_dat_mi <- svydesign(ids = ~ vpsu,
                 strata = ~ vstrat, 
                 weights = ~ wtssall,
                 nest=TRUE, 
                 data=dat_mi)

#survey-set unimputed data for descriptives
svy_dat <- svydesign(ids = ~ vpsu,
                     strata = ~ vstrat,
                     weights = ~ wtssall, 
                     nest=TRUE, 
                     data=dat)
```

# Survey-weighted descriptives

## Demographics and health stratifed by class 

```{r warning=FALSE, message=FALSE}
#vars of interest
vars <- c('sex', 'race_h', 'educ', 'marital_tri', 'region', 'income', 'age', "srh_bin", "mntlhlth")
nonorm <- c('income', 'age')

x <- svyCreateTableOne(data = svy_dat, vars = vars, strata='class')
x <- print(x, printToggle=FALSE, noSpaces=TRUE, nonnormal=nonorm)
kable(x[,1:4]) %>%
  kable_styling(c("striped", "condensed"))
```

# Survey-weighted regressions

```{r, message=FALSE, warning=FALSE}
#regression function
mysvy <- function(dat, outvars, adjvars, ...){
  model <- lapply(as.list(outvars), function(x){
    with(dat, svyglm(as.formula(paste0(names(dat$designs[[1]]$variables)[which(names(dat$designs[[1]]$variables)==x)], adjvars)), family=poisson(), ...))
  })
  return(model)
}

#regression matrix function
matrix_func <- function(nums, coefs, outvars){
  regs_less = NULL
  for(i in 1:nums){
    exp(summary(MIcombine(less_adj[[i]]))[2:coefs,c(1,3,4)]) -> bind
    rbind(regs_less, cbind(bind, outvars[i])) -> regs_less
  }
  names(regs_less) <- c("PR", "Lower", "Upper", "Var")
  return(regs_less)
}

#format matrix function
formatted <- function(classvec, rows, qwlvec, dummy, facvec){
  as.data.frame(regs_less) %>%
    mutate(Class=rep(classvec, rows)) %>%
    bind_rows(data.frame(Var=qwlvec, 
                         Class=rep(dummy, rows), PR=rep(1, rows), Lower=rep(NA, rows), Upper=rep(NA, rows))) %>% #worker dummy row
    mutate(Class=factor(Class, levels=facvec),
           Var=factor(Var, levels=qwlvec),
           Cat=ifelse(Var=="satjob1_bin_unimp" | Var=="rincblls_bin_unimp" | Var=="safehlth_bin_unimp" | Var=="safetywk_bin_unimp", "Rewards/hazards",
                      ifelse(Var=="learnnew_bin_unimp" | Var=="workdiff_bin_unimp" | Var == "workfast_bin_unimp" | Var=="condemnd_bin_unimp", "Labor process",
                             ifelse(Var=="wkdecide_bin_unimp" | Var=="wkfreedm_bin_unimp" | Var == "mustwork_bin_unimp" | Var=="chngtme_bin_unimp", "Autonomy",
                                    ifelse(Var=="manvsemp_bin_unimp" | Var=="trustman_bin_unimp" | Var == "respect_bin_unimp" | Var=="disc_haras_bin_unimp", "Conflict", NA))))) -> binded
  return(binded)
}

#facet labeller function
facet_names <- c(
  "satjob1_bin_unimp"="Dissatisfied with job",
  "rincblls_bin_unimp"="Income doesn't pay bills",
  "safehlth_bin_unimp"="Poor safety conditions",
  "safetywk_bin_unimp"="Safety not a priority",
  "workdiff_bin_unimp"="Repetitive tasks",
  "learnnew_bin_unimp"="Don't learn new things",
  "condemnd_bin_unimp"="Face conflicting demands",
  "workfast_bin_unimp"="Need to work fast", 
  "wkdecide_bin_unimp"="Don't make decisions", 
  "wkfreedm_bin_unimp"="Lack freedom on job", 
  "mustwork_bin_unimp"="Mandatory extra hours",
  "chngtme_bin_unimp"="Can't change schedule",
  "manvsemp_bin_unimp"="Worker-manager conflict", 
  "trustman_bin_unimp"="Don't trust management",
  "respect_bin_unimp"="Not treated with respect",
  "disc_haras_bin_unimp"="Face discrim. & harass."
)

#plot function
plotted <- function(binded, limitsvec, breaksvec, cols, shapes){
  ggplot(binded, aes(y=Class, x=PR, xmin=Lower, xmax=Upper, shape=Class, color=Class)) +
    geom_vline(xintercept=1, lty=1, col='darkgrey') +
    geom_errorbar(width=0.25) +
    geom_point() +
    facet_wrap(~Var, ncol=4, labeller=as_labeller(facet_names)) +
    scale_x_continuous(trans="log", limits=limitsvec, breaks=breaksvec, labels=scales::number_format(accuracy=0.01)) +
    theme_light() + 
    scale_color_manual(values=cols) +
    scale_shape_manual(values=shapes) +
    scale_y_discrete(limits=rev(levels(binded$Class))) +
    theme(strip.background = element_blank(), strip.text = element_blank(), legend.position='none', panel.grid.major.y = element_blank(), 
          axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.y=element_blank(), plot.margin=margin(2.5,0,0,0)) 
}

#table function
tabled <- function(dat, captioned){
  kable(dat, digits=2, col.names=c("PR", "Lower", "Upper", "QWL variable", "Class"), caption=captioned) %>%
    kable_styling("striped") %>%
    group_rows("Class", 1, 12) %>%
    group_rows("Class*gender", 13, 40) %>%
    group_rows("Class*POC", 41, 68) %>%
    scroll_box(width = "100%", height = "250px")
}
```

## Class, race, and gender differences in QWL 

Prevalence of bad category of each binary QWL variable among each class relative to the prevalence among workers adjusted for age and year with restricted cubic splines. Class*race estimates exclude "NH other" group from sample because they're so heterogeneous. 

### Compensation and safety

```{r warning=FALSE, message=FALSE, results='hide'}
#outvars
outvars <- c("satjob1_bin_unimp", "rincblls_bin_unimp", "safehlth_bin_unimp", "safetywk_bin_unimp")

########everyone
#run regression
less_adj <- mysvy(svy_dat_mi, outvars, "~class + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 4, outvars)

#format matrix
binded_overall <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 4,
                            outvars,
                            "Workers",
                            c("Workers", "Managers", "Petite bourgeoisie", "Capitalists"))

#######gender interaction
#run regression
less_adj <- mysvy(svy_dat_mi, outvars, "~class_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_gender <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"), 4,
                           outvars,
                           "Male workers",
                           c("Male workers", "Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"))

#######race interaction
#run regression
less_adj <- mysvy(subset(svy_dat_mi, race_h!="NH other"), outvars, "~class_poc + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_race <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 4,
                          outvars,
                         "White workers",
                         c("White workers", "White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"))
```

```{r warning=FALSE, message=FALSE, fig.height=5, fig.width=10}
#figure
plotted(binded_overall, limitsvec=c(0.09, 3.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2, 4), 
             cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + theme(strip.text=element_text(colour = "black", vjust=1.07)) +
    plotted(binded_gender, limitsvec=c(0.09, 3.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2, 4), 
                 cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
    plotted(filter(binded_race, row_number() != 7), limitsvec=c(0.09, 3.73), breaksvec=c(0.125, 0.25, 0.5, 1, 2, 4), 
            cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) + 
            xlab("Prevalence ratio") + theme(axis.title.x=element_text(), axis.text.x=element_text(), axis.ticks.x=element_line(), axis.title.y=element_blank()) +              geom_text(data=filter(binded_race, row_number()==7), x=-2.3, y=1.13, label="\u2190", color="#4A1486", size=6) +  
            geom_text(data=filter(binded_race, row_number()==28), x=-2.3, y=1.13, label="\u2190", color="#4A1486", size=6) +  
  plot_layout(ncol=1, heights=c(1, 2, 2))

#table 
tabled(rbind(binded_overall[1:12,1:5], binded_gender[1:28,1:5], binded_race[1:28,1:5]), "Ref: workers/male workers/white workers") 
```

### Labor process

```{r warning=FALSE, message=FALSE, results='hide'}
#outvars
outvars <- c("workdiff_bin_unimp", "learnnew_bin_unimp", "condemnd_bin_unimp", "workfast_bin_unimp")

########everyone
#run regression
less_adj <- mysvy(svy_dat_mi, outvars, "~class + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 4, outvars)

#format matrix
binded_overall <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 4,
                            c("workdiff_bin_unimp", "learnnew_bin_unimp", "condemnd_bin_unimp", "workfast_bin_unimp"),
                            "Workers",
                            c("Workers", "Managers", "Petite bourgeoisie", "Capitalists"))

#######gender interaction
#run regression
less_adj <- mysvy(svy_dat_mi, outvars, "~class_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_gender <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"), 4,
                           c("workdiff_bin_unimp", "learnnew_bin_unimp", "condemnd_bin_unimp", "workfast_bin_unimp"),
                           "Male workers",
                           c("Male workers", "Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"))

#######race interaction
#run regression
less_adj <- mysvy(subset(svy_dat_mi, race_h!="NH other"), outvars, "~class_poc + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_race <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 4,
                         outvars,
                         "White workers",
                         c("White workers", "White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"))
```

```{r warning=FALSE, message=FALSE, fig.height=5, fig.width=10}
#figure
plotted(binded_overall, limitsvec=c(0.082, 2.84), breaksvec=c(0.125, 0.25, 0.5, 1, 2, 4), 
             cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + theme(strip.text=element_text(colour = "black", vjust=1.07)) +
    plotted(binded_gender, limitsvec=c(0.082, 2.84), breaksvec=c(0.125, 0.25, 0.5, 1, 2, 4), 
                 cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
    plotted(binded_race, limitsvec=c(0.082, 2.84), breaksvec=c(0.125, 0.25, 0.5, 1, 2, 4), 
            cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) + 
            xlab("Prevalence ratio") + theme(axis.title.x=element_text(), axis.text.x=element_text(), axis.ticks.x=element_line(), axis.title.y=element_blank()) +
  plot_layout(ncol=1, heights=c(1, 2, 2))

#table 
tabled(rbind(binded_overall[1:12,1:5], binded_gender[1:28,1:5], binded_race[1:28,1:5]), "Ref: workers/male workers/white workers") 
```

### Autonomy

```{r message=FALSE, warning=FALSE, results='hide'}
#outvars
outvars <- c("wkdecide_bin_unimp", "wkfreedm_bin_unimp", "mustwork_bin_unimp", "chngtme_bin_unimp")

########everyone
#run regression
less_adj <- mysvy(svy_dat_mi, outvars, "~class + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 4, outvars)

#format matrix
binded_overall <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 4,
                            c("wkdecide_bin_unimp", "wkfreedm_bin_unimp", "mustwork_bin_unimp", "chngtme_bin_unimp"),
                            "Workers",
                            c("Workers", "Managers", "Petite bourgeoisie", "Capitalists"))

#######gender interaction
#run regression
less_adj <- mysvy(svy_dat_mi, outvars, "~class_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_gender <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"), 4,
                           c("wkdecide_bin_unimp", "wkfreedm_bin_unimp", "mustwork_bin_unimp", "chngtme_bin_unimp"),
                           "Male workers",
                           c("Male workers", "Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"))

#######race interaction
#run regression
less_adj <- mysvy(subset(svy_dat_mi, race_h!="NH other"), outvars, "~class_poc + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_race <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 4,
                         outvars,
                         "White workers",
                         c("White workers", "White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"))
```

```{r warning=FALSE, message=FALSE, fig.height=5, fig.width=11}
#figure
plotted(binded_overall, limitsvec=c(0.026, 2.72), breaksvec=c(0.031, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4), 
             cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + theme(strip.text=element_text(colour = "black", vjust=1.07)) +
    plotted(binded_gender, limitsvec=c(0.026, 2.72), breaksvec=c(0.031, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4), 
                 cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
    plotted(binded_race, limitsvec=c(0.026, 2.72), breaksvec=c(0.031, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4), 
            cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) + 
            xlab("Prevalence ratio") + theme(axis.title.x=element_text(), axis.text.x=element_text(), axis.ticks.x=element_line(), axis.title.y=element_blank()) +
  plot_layout(ncol=1, heights=c(1, 2, 2))

#table 
tabled(rbind(binded_overall[1:12,1:5], binded_gender[1:28,1:5], binded_race[1:28,1:5]), "Ref: workers/male workers/white workers") 
```

### Conflict

```{r warning=FALSE, message=FALSE, results='hide'}
#outvars
outvars <- c("manvsemp_bin_unimp", "trustman_bin_unimp", "respect_bin_unimp", "disc_haras_bin_unimp")

########everyone
#run regression
less_adj <- mysvy(svy_dat_mi, outvars, "~class + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 4, outvars)

#format matrix
binded_overall <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 4,
                            c("manvsemp_bin_unimp", "trustman_bin_unimp", "respect_bin_unimp", "disc_haras_bin_unimp"),
                            "Workers",
                            c("Workers", "Managers", "Petite bourgeoisie", "Capitalists"))

#######gender interaction
#run regression
less_adj <- mysvy(svy_dat_mi, outvars, "~class_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_gender <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"), 4,
                           c("manvsemp_bin_unimp", "trustman_bin_unimp", "respect_bin_unimp", "disc_haras_bin_unimp"),
                           "Male workers",
                           c("Male workers", "Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"))

#######race interaction
#run regression
less_adj <- mysvy(subset(svy_dat_mi, race_h!="NH other"), outvars, "~class_poc + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_race <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 4,
                         outvars,
                         "White workers",
                         c("White workers", "White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"))
```

```{r warning=FALSE, message=FALSE, fig.height=5, fig.width=11}
#figure
plotted(binded_overall, limitsvec=c(0.017, 2.42), breaksvec=c(0.031, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4), 
             cols=brewer.pal(8, "Blues")[c(5,6,7,8)], shapes=c(15,16,17,18)) + theme(strip.text=element_text(colour = "black", vjust=1.07)) +
    plotted(binded_gender, limitsvec=c(0.017, 2.42), breaksvec=c(0.031, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4), 
                 cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) +
    plotted(binded_race, limitsvec=c(0.017, 2.42), breaksvec=c(0.031, 0.0625, 0.125, 0.25, 0.5, 1, 2, 4), 
            cols=c(brewer.pal(8, "Blues")[c(5,6,7,8)], brewer.pal(8, "Purples")[c(5,6,7,8)]), shapes=c(15,16,17,18,0,1,2,5)) + 
            xlab("Prevalence ratio") + theme(axis.title.x=element_text(), axis.text.x=element_text(), axis.ticks.x=element_line(), axis.title.y=element_blank()) +
            geom_text(data=filter(binded_race, row_number()==7), x=-3.95, y=1.13, label="\u2190", color="#4A1486", size=6) +  
  plot_layout(ncol=1, heights=c(1, 2, 2))

#table 
tabled(rbind(binded_overall[1:12,1:5], binded_gender[1:28,1:5], binded_race[1:28,1:5]), "Ref: workers/male workers/white workers") 
```

## Gender-race differences in QWL among workers

Prevalence of bad category of each binary QWL variable among each gender-racial group of workers relative to the prevalence among white male workers adjusted for age and year with restricted cubic splines. Estimates exclude "NH other" group from sample because they're so heterogeneous. 

```{r warning=FALSE, message=FALSE, results='hide'}
#outvars
outvars <-  c("satjob1_bin_unimp", "rincblls_bin_unimp", "safehlth_bin_unimp", "safetywk_bin_unimp",
              "workdiff_bin_unimp", "learnnew_bin_unimp", "condemnd_bin_unimp", "workfast_bin_unimp",
              "wkdecide_bin_unimp", "wkfreedm_bin_unimp", "mustwork_bin_unimp", "chngtme_bin_unimp",
              "manvsemp_bin_unimp", "trustman_bin_unimp", "respect_bin_unimp", "disc_haras_bin_unimp")

#run regression
less_adj <- mysvy(subset(svy_dat_mi, class=="Workers" & race_h!="NH other"), outvars, "~poc_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(16, 4, outvars)

#format matrix
binded <- formatted(c("NH white women", "POC men", "POC women"), 16, 
                    outvars,
                    "NH white men",
                    c("NH white men" , "NH white women", "POC men", "POC women"))
```

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=8.75}
#figure
ests <-  ggplot(binded, aes(y=Class, x=PR, xmin=Lower, xmax=Upper, shape=Class, color=Class)) +
    geom_vline(xintercept=1, lty=1, col='darkgrey') +
    geom_errorbar(width=0.25) +
    geom_point() +
    facet_wrap(~Var, ncol=4, labeller=as_labeller(facet_names), dir='v') +
    scale_x_continuous(trans="log", limits=c(0.40, 2.2), breaks=c(0.5, 1, 2), labels=scales::number_format(accuracy=0.01)) +
    theme_light() + 
    scale_color_manual(values=c(brewer.pal(8, "Blues")[c(6,8)], brewer.pal(8, "Purples")[c(6,8)])) +
    scale_shape_manual(values=c(15, 16, 0, 1)) +
    scale_y_discrete(limits=rev(levels(binded$Class))) +
    xlab("Prevalence ratio") +
    theme(strip.background = element_blank(), strip.text = element_text(color='black'), legend.position='none', 
          panel.grid.major.y = element_blank(), axis.title.y=element_blank())
  
comp <-  ggplot() + theme_void() + ggtitle("Compensation/hazards") + theme(plot.title=element_text(hjust=0.5))
process <-  ggplot() + theme_void() + ggtitle("Labor process") + theme(plot.title=element_text(hjust=0.5))
autonomy <-  ggplot() + theme_void() + ggtitle("Autonomy") + theme(plot.title=element_text(hjust=0.5))
conflict <-  ggplot() + theme_void() + ggtitle("Conflict") + theme(plot.title=element_text(hjust=0.5))

(comp + process + autonomy + conflict + plot_layout(ncol=4)) /
  ests + 
  plot_layout(heights=c(0.001, 1000))  

#table
kable(binded[1:48,], caption="Ref: NH white men", digits=2) %>%
  kable_styling("striped") %>%
    scroll_box(width = "100%", height = "250px")
```

# Appendix

## Additional descriptives

### How many employees do PBs and capitalists identify as having? 

Note that the numemps variable wasn't asked in 2002, which is why we aren't using it for our primary analyses. Note also that numemps was only asked of people who identified as self-employed, which supports our use of the self-employed variable to identify owners.

```{r, warning=FALSE, message=FALSE}
#run on unimputed data
dat %>%
  filter(year !=2002 & c(class=="Capitalists" | class=="Petit bourgeoisie")) %>%
  group_by(class) %>%
  summarise(mean_emps=round(mean(as.numeric(numemps), na.rm=T),1), 
            median_emps=round(median(as.numeric(numemps), na.rm=T),1),
            lower_IQR=round(quantile(as.numeric(numemps), 0.25, na.rm=T),1),
            upper_IQR=round(quantile(as.numeric(numemps), 0.75, na.rm=T),1),
            max=max(as.numeric(numemps), na.rm=T)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")
```

### Survey-weighted distributions of QWL variables stratified by class 

Unadjusted prevalence of bad category of each binary QWL variable among each class.

```{r warning=FALSE, message=FALSE}
#vars of interest
qwl_vars <- c("satjob1_bin", "rincblls_bin", "safehlth_bin", "safetywk_bin", "workdiff_bin", "learnnew_bin", "condemnd_bin", "workfast_bin", "wkdecide_bin", "wkfreedm_bin", "mustwork_bin", "chngtme_bin", "manvsemp_bin", "trustman_bin", "respect_bin", "disc_haras_bin")

x <- svyCreateTableOne(data = svy_dat, vars = qwl_vars, strata='class')
x <- print(x, printToggle=FALSE, noSpaces=TRUE)
kable(x[,1:4]) %>%
  kable_styling(c("striped", "condensed"))
```

### Survey-weighted distributions of QWL variables stratified by race-gender 

Unadjusted prevalence of bad category of each binary QWL variable among each race-gender

```{r warning=FALSE, message=FALSE}
x <- svyCreateTableOne(data = svy_dat, vars = qwl_vars, strata='poc_gender')
x <- print(x, printToggle=FALSE, noSpaces=TRUE)
kable(x[,1:4]) %>%
  kable_styling(c("striped", "condensed"))
```

### Survey-weighted distributions of class stratified by race-gender 

```{r warning=FALSE, message=FALSE}
x <- svyCreateTableOne(data = svy_dat, vars = "class", strata='poc_gender')
x <- print(x, printToggle=FALSE, noSpaces=TRUE)
kable(x[,1:4]) %>%
  kable_styling(c("striped", "condensed"))
```

### Survey-weighted distributions of family income stratified by class-gender-race 

```{r warning=FALSE, message=FALSE}
x <- svyCreateTableOne(data = svy_dat, vars = 'income', strata=c("class_gender", "poc"))
x <- print(x, printToggle=FALSE, noSpaces=TRUE, nonnormal='income')
kable(x[,1:16]) %>%
  kable_styling(c("striped", "condensed"))
```

## Data management

Confirming that class, race, and gender variables are coded correctly

```{r warning=FALSE, message=FALSE}
#class variable 
kable(table(dat$class, dat$wrkslf, dat$wksup, dat$occ10=="chief executives"), caption="Class by self employed by supervisor by chief executive", col.names=c("Class", "Self-employed", "Supervisor", "Chief executive", "Count")) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")

#class-gender variable 
kable(table(dat$class_gender, dat$sex), caption="Class-gender by gender", col.names=c("Class-gender", "Gender")) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")

#class-POC variable
kable(table(dat$class_poc, dat$poc), caption="Class-POC by POC") %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")

#race-gender variable
kable(table(dat$poc_gender, dat$race_h, dat$sex), caption="Race-gender by race and gender", col.names=c("Race-gender", "Race", "Gender", "Count")) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "250px")
```

## Missingness patterns

```{r warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
aggr(dat[,c("class", 'sex', 'poc', 'educ', 'marital_tri', 'region', 'income',  "prestg10", 'age', "srh_bin", "mntlhlth", "satjob1_bin", "rincblls_bin", "safehlth_bin", "safetywk_bin", "workdiff_bin", "learnnew_bin", "condemnd_bin", "workfast_bin", "wkdecide_bin", "wkfreedm_bin", "mustwork_bin", "chngtme_bin", "manvsemp_bin", "trustman_bin", "respect_bin", "disc_haras_bin")], cex.axis = 0.6, numbers=FALSE, prop=TRUE)
```

## Imputation convergence plots

```{r, warning=FALSE, message=FALSE} 
plot(imp_merged, y=c('class', 'race_h', 'educ', 'marital_tri', "prestg10", 'income', 'age', "srh_bin", "mntlhlth", "satjob1_bin", "rincblls_bin", "safehlth_bin", "safetywk_bin", "workdiff_bin", "learnnew_bin", "condemnd_bin", "workfast_bin", "wkdecide_bin", "wkfreedm_bin", "mustwork_bin", "manvsemp_bin", "trustman_bin", "respect_bin", "disc_haras_bin"), main='Convergence plots')
```

## Unimputed analyses

### Class, race, and gender differences in QWL 

Prevalence of bad category of each binary QWL variable among each class relative to the prevalence among workers adjusted for age and year with restricted cubic splines. Class*race estimates exclude "NH other" group from sample because they're so heterogeneous. 

#### Compensation and safety

```{r warning=FALSE, message=FALSE, results='hide'}
#outvars
outvars <- c("satjob1_bin_unimp", "rincblls_bin_unimp", "safehlth_bin_unimp", "safetywk_bin_unimp")

#functions
mysvy <- function(dat, columns, adjvars, ...) {
  model <- lapply(as.list(columns), function(x) {
    svyglm(as.formula(paste0(names(dat$variables)[which(names(dat$variables)==x)], adjvars)), family=poisson(), design=dat)
  })
  return(model)
}

matrix_func <- function(nums, coefs, outvars){
  regs_less = NULL
  for(i in 1:nums){
    cbind(exp(less_adj[[i]]$coefficients[2:coefs]), exp(confint(less_adj[[i]])[2:coefs,])) -> bind
    rbind(regs_less, cbind(bind, outvars[i])) -> regs_less
  }
  regs_less <- data.frame(regs_less)
  names(regs_less) <- c("PR", "Lower", "Upper", "Var")
  return(regs_less)
}

formatted <- function(classvec, rows, qwlvec){
  regs_less %>%
    mutate(Class=factor(rep(classvec, rows), levels=classvec),
           PR=as.numeric(PR), Lower=as.numeric(Lower), Upper=as.numeric(Upper),
           Var=factor(Var, levels=qwlvec),
           Cat=ifelse(Var=="satjob1_bin_unimp" | Var=="rincblls_bin_unimp" | Var=="safehlth_bin_unimp" | Var=="safetywk_bin_unimp", "Rewards/hazards",
                      ifelse(Var=="learnnew_bin_unimp" | Var=="workdiff_bin_unimp" | Var == "workfast_bin_unimp" | Var=="condemnd_bin_unimp", "Labor process",
                             ifelse(Var=="wkdecide_bin_unimp" | Var=="wkfreedm_bin_unimp" | Var == "mustwork_bin_unimp" | Var=="chngtme_bin_unimp", "Autonomy",
                                    ifelse(Var=="manvsemp_bin_unimp" | Var=="trustman_bin_unimp" | Var == "respect_bin_unimp" | Var=="disc_haras_bin_unimp", "Conflict", NA))))) -> binded
  return(binded)
}

########everyone
#run regression
less_adj <- mysvy(svy_dat, outvars, "~class + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 4, outvars)

#format matrix
binded_overall <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 4, outvars)

#######gender interaction
#run regression
less_adj <- mysvy(svy_dat, outvars, "~class_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_gender <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"), 4, outvars)

#######race interaction
#run regression
less_adj <- mysvy(subset(svy_dat, race_h!="NH other"), outvars, "~class_poc + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_race <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 4, outvars)
```

```{r warning=FALSE, message=FALSE}
#table 
tabled(rbind(binded_overall[1:12,1:5], binded_gender[1:28,1:5], binded_race[1:28,1:5]), "Ref: workers/male workers/white workers")
```

#### Labor process

```{r warning=FALSE, message=FALSE, results='hide'}
#outvars
outvars <- c("workdiff_bin_unimp", "learnnew_bin_unimp", "condemnd_bin_unimp", "workfast_bin_unimp")

########everyone
#run regression
less_adj <- mysvy(svy_dat, outvars, "~class + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 4, outvars)

#format matrix
binded_overall <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 4, outvars)

#######gender interaction
#run regression
less_adj <- mysvy(svy_dat, outvars, "~class_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_gender <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"), 4, outvars)

#######race interaction
#run regression
less_adj <- mysvy(subset(svy_dat, race_h!="NH other"), outvars, "~class_poc + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_race <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 4, outvars)
```

```{r warning=FALSE, message=FALSE}
#table 
tabled(rbind(binded_overall[1:12,1:5], binded_gender[1:28,1:5], binded_race[1:28,1:5]), "Ref: workers/male workers/white workers")
```

#### Autonomy

```{r message=FALSE, warning=FALSE, results='hide'}
#outvars
outvars <- c("wkdecide_bin_unimp", "wkfreedm_bin_unimp", "mustwork_bin_unimp", "chngtme_bin_unimp")

########everyone
#run regression
less_adj <- mysvy(svy_dat, outvars, "~class + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 4, outvars)

#format matrix
binded_overall <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 4, outvars)

#######gender interaction
#run regression
less_adj <- mysvy(svy_dat, outvars, "~class_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_gender <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"), 4, outvars)

#######race interaction
#run regression
less_adj <- mysvy(subset(svy_dat, race_h!="NH other"), outvars, "~class_poc + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_race <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 4, outvars)
```

```{r warning=FALSE, message=FALSE}
#table 
tabled(rbind(binded_overall[1:12,1:5], binded_gender[1:28,1:5], binded_race[1:28,1:5]), "Ref: workers/male workers/white workers")
```

#### Conflict

```{r warning=FALSE, message=FALSE, results='hide'}
#outvars
outvars <- c("manvsemp_bin_unimp", "trustman_bin_unimp", "respect_bin_unimp", "disc_haras_bin_unimp")

########everyone
#run regression
less_adj <- mysvy(svy_dat, outvars, "~class + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 4, outvars)

#format matrix
binded_overall <- formatted(c("Managers", "Petite bourgeoisie", "Capitalists"), 4, outvars)

#######gender interaction
#run regression
less_adj <- mysvy(svy_dat, outvars, "~class_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_gender <- formatted(c("Male managers", "Male petite bourgeoisie", "Male capitalists",
                             "Female workers", "Female managers", "Female petite bourgeoisie", "Female capitalists"), 4, outvars)

#######race interaction
#run regression
less_adj <- mysvy(subset(svy_dat, race_h!="NH other"), outvars, "~class_poc + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(4, 8, outvars)

#format matrix
binded_race <- formatted(c("White managers", "White petite bourgeoisie", "White capitalists",
                           "POC workers", "POC managers", "POC petite bourgeoisie", "POC capitalists"), 4, outvars)
```

```{r warning=FALSE, message=FALSE}
#table 
tabled(rbind(binded_overall[1:12,1:5], binded_gender[1:28,1:5], binded_race[1:28,1:5]), "Ref: workers/male workers/white workers")
```

### Gender-race differences in QWL among workers

Prevalence of bad category of each binary QWL variable among each gender-racial group of workers relative to the prevalence among white male workers adjusted for age and year with restricted cubic splines. Estimates exclude "NH other" group from sample because they're so heterogeneous. 

```{r warning=FALSE, message=FALSE, results='hide'}
#outvars
outvars <-  c("satjob1_bin_unimp", "rincblls_bin_unimp", "safehlth_bin_unimp", "safetywk_bin_unimp",
              "workdiff_bin_unimp", "learnnew_bin_unimp", "condemnd_bin_unimp", "workfast_bin_unimp",
              "wkdecide_bin_unimp", "wkfreedm_bin_unimp", "mustwork_bin_unimp", "chngtme_bin_unimp",
              "manvsemp_bin_unimp", "trustman_bin_unimp", "respect_bin_unimp", "disc_haras_bin_unimp")

#run regression
less_adj <- mysvy(subset(svy_dat, class=="Workers" & race_h!="NH other"), outvars, "~poc_gender + rcs(age, 3) + rcs(year, 3)")

#pull into matrix
regs_less <- matrix_func(16, 4, outvars)

#format matrix
binded <- formatted(c("NH white women", "POC men", "POC women"), 16, outvars)
```

```{r warning=FALSE, message=FALSE}
#table
kable(binded[1:48,], caption="Ref: NH white men", digits=2) %>%
  kable_styling("striped") %>%
    scroll_box(width = "100%", height = "250px")
```