---
title: "Intro data exploration"
author: "Jerzy Eisenberg-Guyot"
date: "10/21/2020"
output: 
  html_document:
    code_folding: hide
    toc: true
    keep_md: true
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

**General notes**

Some QWL variables have lots of missingness because they weren't asked of every ballot in a given year

I made the QWL variables binary for the regression analyses for simplicity and stability

**Codebook for non-self-explanatory variables**

* Class variables:
    + explained in IJHS (2020) paper

* Health variables:
    + srh_bin: poor/fair vs good/vgood/excellent self-rated health
    + depress: whether respondent has ever been diagnosed by a healthcare professional with depression
    + mntlhlth: days of poor mental health in past 30 days

* Relevant QWL variables:
    + mustwork: Mandatory to work extra hours
    + chngtme: How often r allowed change schedule
    + famwkoff: How hard to take time off
    + wkvsfam: How often job interferes fam life
    + secondwk: R has job other than main
    + learnnew: Job requires r to learn new things
    + workfast: Job requires r to work fast
    + wrktime: R has enough time to get the job done
    + workdiff: R does numerous things on job
    + toofewwk: How often not enough staff
    + overwork: R has too much work to do well
    + myskills: Job allows r use of skills
    + trainops: R have the training opportunities
    + opdevel: Opportunity to develop my abilities
    + respect: R treated with respect at work
    + trustman: R trust management at work
    + manvsemp: Relations bw management and employees
    + suphelp: Supervisor helpful to r in getting job done
    + supcares: Supervisor concerned about welfare
    + wkfreedm: A lot of freedom to decide how to do job
    + lotofsay: R has lot of say in job
    + wkdecide: How often r take part in decisions
    + satjob1: 	Job satisfaction in general
    + fairearn: How fair is what r earn on the job
    + fringeok: Fringe benefits are good
    + rincblls: Income alone is enough
    + laidoff: R was laid off main job last year
    + jobsecok: The job security is good
    + any_disc_haras: Any discrimination or harassment on job (created by me from several more specific variables focused separately on racism, sexism, etc.)
    + safetywk: Worker safety priority at work
    + safehlth: Safety and health condition good at work
    + safefrst: No shortcuts on worker safety

```{r warning=FALSE, message=FALSE}
library(readstata13)
library(tidyr)
library(dplyr)
library(survival)
library(knitr)
library(ggplot2)
library(kableExtra)
library(survey)
library(tableone)
library(RColorBrewer)
library(survey)
library(VIM)
library(mice)
library(parallel)
library(mitools)
library(viridis)
library(survminer)
library(gridExtra)
library(stringr)
library(rms)
library(patchwork) 
library(spatstat)
library(purrr)

#########load data and subset to those who are working fulltime, part time, or temporarily not working (the only people who were asked the QWL variables)
#note that not all QWL variables were asked in every year, and within years, not all QWL/non-QWL variables were asked on every ballot

#load data
read.dta13('GSS_02_06_10_14_18.dta') %>% 
  droplevels() -> dat

#subset
dat <- subset(dat, wrkstat=="working fulltime" | wrkstat=="working parttime" | wrkstat=="temp not working")

########potential variables of interest (dataset already subsetted, but useful if we need to do again and add some variables)
#####
#

#vars <- c("ballot", "id", "year", "wrkstat", "wrkslf", "wrkgovt", "health1", "health", "mntlhlth", 
#          "occ10", "indus10", "marital", "spwrkslf", "age", "degree", "padeg", "madeg", "spdeg", 
#          "wksup", "wksups", "union", "prestg10", "prestg105plus", "sex", "race", "income", "rincome",
#          "coninc", "conrinc", "region", "hispanic", "sample", "wtssall", "vstrat", "vpsu", #QWL vars start on next line
#          'cowrkint', 'laidoff', 'jobfind1', 'trynewjb', 'wkageism', 'wkracism', 'wksexism', 'wkharsex', 
#          'wkharoth', 'health1', 'rincblls', 'fairearn', 'wkbonus', 'jobsecok', 'suphelp', 'wrktime',
#          'cowrkhlp', 'trainops', 'manvsemp', 'hvylift', 'handmove', 'wkpraise', 'physhlth', 'mntlhlth',
#          'hyperten', 'depress', 'misswork', 'usetech', 'knowschd', 'satjob1', 'hlthdays', 'usedup',
#          'backpain', 'painarms', 'hurtatwk', 'spvtrfair', 'strredpg', 'phyeffrt', 'slpprblm', 'promtefr',
#          'year', 'famvswk', 'hrsrelax', 'secondwk', 'learnnew', 'workfast', 'workdiff', 'lotofsay', 'wktopsat', 
#          'overwork', 'wkvsfam', 'famwkoff', 'whywkhme', 'wrktype', 'yearsjob', 'waypaid', 'wrksched', 
#          'moredays', 'mustwork', 'chngtme', 'wrkhome', 'knowwhat', 'myskills', 'setthngs',
#          'toofewwk', 'promteok', 'opdevel', 'hlpequip', 'haveinfo', 'wkfreedm', 'fringeok', 'supcares',
#          'wkdecide', 'partteam', 'trdunion', 'respect', 'trustman', 'safetywk', 'safefrst', 'teamsafe',
#          'safehlth', 'proudemp', 'prodctiv', 'wksmooth', 'condemnd')

#subset of QWL variables we'll focus on for now
#qwl_vars <- c("mustwork", "chngtme", "famwkoff", "wkvsfam", "secondwk", "learnnew", "workfast",
#              "wrktime", "workdiff", "toofewwk", "overwork", "myskills", "trainops",  "opdevel",
#              "respect", "trustman", "manvsemp", "suphelp", "supcares", "wkfreedm", "lotofsay", "wkdecide",  "satjob1", 
#              "fairearn", "fringeok", "rincblls", "laidoff", "jobsecok", "any_disc_haras", "safetywk", "safehlth", "safefrst")

#########make variables
######
#

dat %>% 
  mutate(educ = factor(ifelse(degree == "bachelor" | degree == "graduate", "College +", 
                              ifelse(degree== "high school", "HS", 
                                     ifelse(degree == "junior college", "JuCo", 
                                            ifelse(degree == "lt high school", "<HS", NA)))),
                       levels=c("<HS", "HS", "JuCo", "College +")), 
         region = factor(ifelse(region == "new england" | region == "middle atlantic", "Northeast",
                                   ifelse(region == "e. sou. central" | region == "south atlantic" | region == "w. sou. central", "South",
                                          ifelse(region == "e. nor. central" | region == "w. nor. central", "Midwest", "West")))),
         marital_tri=ifelse(marital=="married", "married",
                            ifelse(marital=="never married", "never married",
                                   ifelse(marital=="widowed" | marital=="divorced" | marital=="separated", "wid/div/sep", marital))),
         srh_bin=ifelse(health1 == "fair" | health1 == "poor", "poor/fair", "good/vgood/exc"), 
         any_disc_haras=ifelse(wkageism=="yes" | wkracism=="yes" | wksexism=="yes" | wkharsex=="yes" | wkharoth=="yes", 1, 0),
         respect_bin=ifelse(respect=="disagree" | respect=="strongly disagree", 1, 0),
         trustman_bin=ifelse(trustman=="disagree" | trustman=="strongly disagree", 1, 0),
         manvsemp_bin=ifelse(manvsemp=="quite bad" | manvsemp=="very bad", 1, 0),
         suphelp_bin=ifelse(suphelp=="not too true" | suphelp=="not at all true", 1, 0),
         supcares_bin=ifelse(supcares=="not too true" | supcares=="not at all true", 1, 0),
         wkfreedm_bin=ifelse(wkfreedm=="not too true" | wkfreedm=="not at all true", 1, 0),
         wkdecide_bin=ifelse(wkdecide=="rarely" | wkdecide=="never", 1, 0),
         safehlth_bin=ifelse(safehlth=="disagree" | safehlth=="strongly disagree", 1, 0),
         safefrst_bin=ifelse(safefrst=="disagree" | safefrst=="strongly disagree", 1, 0),
         income=as.numeric(as.character(coninc)) * 251.1 / 172.2, #adjust income to 2018 dollars from 2000 dollars
         prestg10_bin=ifelse(prestg10 < weighted.median(prestg10, w=wtssall, na.rm=T), "low prestige", "high prestige"),  #prestige below median
         #we could also create the class variable using numemps (number of employees employed by the self-employed), but it's not available in 2002 
         class_det=factor(ifelse((wksup == "yes" & wksups == "yes" & wrkslf == "self-employed") | (wksup == "yes" & wksups == "yes" & wrkslf == "someone else" & occ10 == "chief executives"), "Large capitalists", 
                                          ifelse((wksup == "yes" & wksups == "no" & wrkslf == "self-employed") | (wksup == "yes" & wksups == "no" & wrkslf == "someone else" & occ10 == "chief executives"), "Small capitalists",
                                                  ifelse((wksup == "no" & wrkslf == "self-employed") | (wksup == "no" & wrkslf == "someone else" & occ10 == "chief executives"), "Petit bourgeoisie", 
                                                          ifelse(wksup == "yes" & wksups == "yes" & wrkslf == "someone else" & occ10 != "chief executives", "High-level managers",
                                                                         ifelse(wksup == "yes" & wksups == "no" & wrkslf == "someone else" & occ10 != "chief executives", "Low-level managers",
                                                                                ifelse(wksup == "no" & wrkslf ==  "someone else" & occ10 != "chief executives" & prestg10_bin == "low prestige", "Less-skilled workers", 
                                                                                       ifelse(wksup == "no" & wrkslf ==  "someone else" & occ10 != "chief executives" & prestg10_bin == "high prestige", "More-skilled workers", NA))))))), 
                                             levels=c("Less-skilled workers", "More-skilled workers", "Low-level managers", "High-level managers", "Petit bourgeoisie", "Small capitalists", "Large capitalists")),
         class=factor(ifelse((wksup == "yes" & wrkslf == "self-employed") | (wksup == "yes" & wrkslf == "someone else" & occ10 == "chief executives"), "Capitalists", 
                              ifelse((wksup == "no" & wrkslf == "self-employed") | (wksup == "no" & wrkslf == "someone else" & occ10 == "chief executives"), "Petit bourgeoisie", 
                                                 ifelse(wksup == "yes" & wrkslf == "someone else" & occ10 != "chief executives", "Managers", 
                                                        ifelse(wksup == "no" & wrkslf ==  "someone else" & occ10 != "chief executives", "Workers", NA)))), 
                                   levels=c("Workers", "Managers", "Petit bourgeoisie", "Capitalists")),
         class_gender=factor(ifelse(class=="Workers" & sex=="male", "Male workers",
                                    ifelse(class=="Workers" & sex=="female", "Female workers",
                                           ifelse(class=="Managers" & sex=="male", "Male managers",
                                                  ifelse(class=="Managers" & sex=="female", "Female managers",
                                                         ifelse(class=="Petit bourgeoisie" & sex=="male", "Male petit bourgeoisie",
                                                                ifelse(class=="Petit bourgeoisie" & sex=="female", "Female petit bourgeoisie",
                                                                       ifelse(class=="Capitalists" & sex=="male", "Male capitalists",
                                                                              ifelse(class=="Capitalists" & sex=="female", "Female capitalists", NA)))))))),
                             levels=c("Male workers", "Male managers", "Male petit bourgeoisie", "Male capitalists", "Female workers", "Female managers", "Female petit bourgeoisie", "Female capitalists"))) -> dat
```

```{r warning=FALSE, message=FALSE}
#center data for the single-PSU stratum at the sample grand mean rather than the stratum mean (conservative)
options(survey.lonely.psu="adjust")

svy_dat <- svydesign(ids = ~ vpsu,
                     strata = ~ vstrat,
                     weights = ~ wtssall, 
                     nest=TRUE, 
                     data=dat)
```

# Survey-weighted, unimputed descriptives

## Demographics and health stratifed by class 

```{r warning=FALSE, message=FALSE}
#vars of interest
vars <- c('sex', 'race', 'educ', 'marital_tri', 'region', 'income', 'age', "srh_bin", "mntlhlth", "depress")
nonorm <- c('income', 'age')

#aggregate
x <- svyCreateTableOne(data = svy_dat, vars = vars, strata='class')
x <- print(x, printToggle=FALSE, noSpaces=TRUE, nonnormal=nonorm)
kable(x[,1:4], caption="Simple") %>%
  kable_styling(c("striped", "condensed"))

#most disaggregate
x <- svyCreateTableOne(data = svy_dat, vars = vars, strata='class_det')
x <- print(x, printToggle=FALSE, noSpaces=TRUE, nonnormal=nonorm)
kable(x[,1:7], caption="Complex") %>%
  kable_styling(c("striped", "condensed"))
```

## QWL variables stratified by class 

```{r warning=FALSE, message=FALSE}
#vars of interest
qwl_vars <- c("mustwork", "chngtme", "famwkoff", "wkvsfam", "secondwk", "learnnew", "workfast",
              "wrktime", "workdiff", "toofewwk", "overwork", "myskills", "trainops",  "opdevel",
              "respect", "trustman", "manvsemp", "suphelp", "supcares", "wkfreedm", "lotofsay", "wkdecide",  "satjob1", 
              "fairearn", "fringeok", "rincblls", "laidoff", "jobsecok", "any_disc_haras", "safetywk", "safehlth", "safefrst")

#aggregate
x <- svyCreateTableOne(data = svy_dat, vars = qwl_vars, strata='class')
x <- print(x, printToggle=FALSE, noSpaces=TRUE)
kable(x[,1:4], caption="Simple") %>%
  kable_styling(c("striped", "condensed"))

#most disaggregate
x <- svyCreateTableOne(data = svy_dat, vars = qwl_vars, strata='class_det')
x <- print(x, printToggle=FALSE, noSpaces=TRUE)
kable(x[,1:7], caption="Complex") %>%
  kable_styling(c("striped", "condensed"))
```

# Survey-weighted associations between QWL variables and class from Poisson regressions

Restricted to intrinsically relational variables with potentially interesting differences across classes or races

## Class and QWL 

Prevalence of bad category of each binary QWL variable among each class relative to the prevalence among workers w/ various levels of adjustment

### No gender interaction

```{r warning=FALSE, message=FALSE, fig.height=12, fig.width=8}
mysvy <- function(data, columns, adjvars, ...) {
  model <- lapply(as.list(columns), function(x) {
    svyglm(as.formula(paste0(names(data)[x], adjvars)), 
           data = data, family=poisson(), ...)
  })
  return(model)
}

#less adjusted
less_adj <- mysvy(dat, 124:133, "~class + rcs(age, 3) + rcs(year, 3)", design = svy_dat)

regs_less = NULL
for(i in 1:10){
  cbind(exp(less_adj[[i]]$coefficients[2:4]), exp(confint(less_adj[[i]])[2:4,])) -> bind
  rbind(regs_less, cbind(bind, rep(names(dat)[124:133][i],3))) -> regs_less
}

#more adjusted
more_adj <- mysvy(dat, 124:133, "~class + rcs(age, 3) + rcs(year, 3) + sex + race", design = svy_dat)

regs_more = NULL
for(i in 1:10){
  cbind(exp(more_adj[[i]]$coefficients[2:4]), exp(confint(more_adj[[i]])[2:4,])) -> bind
  rbind(regs_more, cbind(bind, rep(names(dat)[124:133][i],3))) -> regs_more
}

#fully adjusted
full_adj <- mysvy(dat, 124:133, "~class + rcs(age, 3) + rcs(year, 3) + sex + race + region + educ", design = svy_dat)

regs_full = NULL
for(i in 1:10){
  cbind(exp(full_adj[[i]]$coefficients[2:4]), exp(confint(full_adj[[i]])[2:4,])) -> bind
  rbind(regs_full, cbind(bind, rep(names(dat)[124:133][i],3))) -> regs_full
}

#bind together
binded <- rbind(cbind(regs_less, rep("Age+year", 30)), cbind(regs_more, rep("Age+year+gender+race", 30)), cbind(regs_full, rep("Age+year+gender+race+educ+region", 30)))

#format
binded %>%
  as.data.frame() %>%
  mutate(Class=factor(rep(c("Managers", "Petit bourgeoisie", "Capitalists"), 30), levels=c("Managers", "Petit bourgeoisie", "Capitalists")),
         V5=factor(V5, levels=c("Age+year", "Age+year+gender+race", "Age+year+gender+race+educ+region")),
         `Prevalence ratio`=as.numeric(V1),
         Lower=as.numeric(`2.5 %`),
         Upper=as.numeric(`97.5 %`)) -> binded

#plot
ggplot(binded, aes(y=Class, x=`Prevalence ratio`, xmin=Lower, xmax=Upper, group=rev(V5), shape=V5, color=V5)) +
  geom_point(position=position_dodge(width = 0.5)) +
  geom_errorbar(position=position_dodge(width = 0.5)) + 
  geom_vline(xintercept=1, lty=2, col='darkgrey') +
  facet_grid(V4~.) +
  scale_x_continuous(trans="log", limits=c(0.039, 1.9), breaks=c(0.1, 0.4, 0.7, 1, 1.3, 1.6, 1.9), labels=c("0.1", "0.4", "0.7", "1.0", "1.3", "1.6", "1.9")) +
  scale_y_discrete(limits=rev(levels(binded$Class))) +
  theme_light() + 
  scale_color_manual(values=brewer.pal(8, "Blues")[c(4,6,8)]) +
  theme(strip.background = element_rect(fill=NA, color='grey'), strip.text = element_text(colour = "black"), legend.position='bottom', legend.title=element_blank())
```

### Gender interaction

```{r warning=FALSE, message=FALSE, fig.height=12, fig.width=12}
#less adjusted men
less_adj <- mysvy(dat, 124:133, "~class*sex + rcs(age, 3) + rcs(year, 3)", design = svy_dat)

regs_less_men = NULL
for(i in 1:10){
  cbind(exp(less_adj[[i]]$coefficients[2:4]), exp(confint(less_adj[[i]])[2:4,])) -> bind
  rbind(regs_less_men, cbind(bind, rep(names(dat)[124:133][i],3))) -> regs_less_men
}

#less adjusted women
less_adj <- mysvy(dat, 124:133, "~class*relevel(sex, 'female') + rcs(age, 3) + rcs(year, 3)", design = svy_dat)

regs_less_women = NULL
for(i in 1:10){
  cbind(exp(less_adj[[i]]$coefficients[2:4]), exp(confint(less_adj[[i]])[2:4,])) -> bind
  rbind(regs_less_women, cbind(bind, rep(names(dat)[124:133][i],3))) -> regs_less_women
}

#more adjusted men
more_adj <- mysvy(dat, 124:133, "~class*sex + rcs(age, 3) + rcs(year, 3) + race", design = svy_dat)

regs_more_men = NULL
for(i in 1:10){
  cbind(exp(more_adj[[i]]$coefficients[2:4]), exp(confint(more_adj[[i]])[2:4,])) -> bind
  rbind(regs_more_men, cbind(bind, rep(names(dat)[124:133][i],3))) -> regs_more_men
}

#more adjusted women
more_adj <- mysvy(dat, 124:133, "~class*relevel(sex, 'female') + rcs(age, 3) + rcs(year, 3) + race", design = svy_dat)
                  
regs_more_women = NULL
for(i in 1:10){
  cbind(exp(more_adj[[i]]$coefficients[2:4]), exp(confint(more_adj[[i]])[2:4,])) -> bind
  rbind(regs_more_women, cbind(bind, rep(names(dat)[124:133][i],3))) -> regs_more_women
}

#fully adjusted men
full_adj <- mysvy(dat, 124:133, "~class*sex + rcs(age, 3) + rcs(year, 3) + race + region + educ", design = svy_dat)

regs_full_men = NULL
for(i in 1:10){
  cbind(exp(full_adj[[i]]$coefficients[2:4]), exp(confint(full_adj[[i]])[2:4,])) -> bind
  rbind(regs_full_men, cbind(bind, rep(names(dat)[124:133][i],3))) -> regs_full_men
}

#fully adjusted women
full_adj <- mysvy(dat, 124:133, "~class*relevel(sex, 'female') + rcs(age, 3) + rcs(year, 3) + race + region + educ", design = svy_dat)

regs_full_women = NULL
for(i in 1:10){
  cbind(exp(full_adj[[i]]$coefficients[2:4]), exp(confint(full_adj[[i]])[2:4,])) -> bind
  rbind(regs_full_women, cbind(bind, rep(names(dat)[124:133][i],3))) -> regs_full_women
}

#bind together
binded <- rbind(cbind(regs_less_men, rep("Age+year", 30)), cbind(regs_less_women, rep("Age+year", 30)), 
                cbind(regs_more_men, rep("Age+year+race", 30)), cbind(regs_more_women, rep("Age+year+race", 30)), 
                cbind(regs_full_men, rep("Age+year+race+educ+region", 30)), cbind(regs_full_women, rep("Age+year+race+educ+region", 30)))

#format
binded %>%
  as.data.frame() %>%
  mutate(Class=factor(rep(c("Managers", "Petit bourgeoisie", "Capitalists"), 60), levels=c("Managers", "Petit bourgeoisie", "Capitalists")),
         V5=factor(V5, levels=c("Age+year", "Age+year+race", "Age+year+race+educ+region")),
         Gender=rep(c(rep("Men", 30), rep("Women", 30)), 3),
         `Prevalence ratio`=as.numeric(V1),
         Lower=as.numeric(`2.5 %`),
         Upper=as.numeric(`97.5 %`)) -> binded

#plot
ggplot(binded, aes(y=Class, x=`Prevalence ratio`, xmin=Lower, xmax=Upper, group=rev(V5), shape=V5, color=V5)) +
  geom_point(position=position_dodge(width = 0.5)) +
  geom_errorbar(position=position_dodge(width = 0.5)) + 
  geom_vline(xintercept=1, lty=2, col='darkgrey') +
  facet_grid(V4~Gender) +
  scale_x_continuous(trans="log", limits=c(0.016, 2.31), breaks=c(0.1, 0.55, 1, 1.45, 1.9, 2.35), labels=c("0.1", "0.55", "1.0", "1.45", "1.9", "2.35")) +
  scale_y_discrete(limits=rev(levels(binded$Class))) +
  theme_light() + 
  scale_color_manual(values=brewer.pal(8, "Blues")[c(4,6,8)]) +
  theme(strip.background = element_rect(fill=NA, color='grey'), strip.text = element_text(colour = "black"), legend.position='bottom', legend.title=element_blank())
```

## Race and QWL among workers

Prevalence of bad category of each binary QWL variable among Black or "other" workers relative to the prevalence among white workers w/ various levels of adjustment

### No gender interaction

```{r warning=FALSE, message=FALSE, fig.height=12, fig.width=8}
#less adjusted
less_adj <- mysvy(dat, 124:133, "~race + rcs(age, 3) + rcs(year, 3)", design = subset(svy_dat, class=="Workers"))

regs_less = NULL
for(i in 1:10){
  cbind(exp(less_adj[[i]]$coefficients[2:3]), exp(confint(less_adj[[i]])[2:3,])) -> bind
  rbind(regs_less, cbind(bind, rep(names(dat)[124:133][i],2))) -> regs_less
}

#more adj
more_adj <- mysvy(dat, 124:133, "~race + rcs(age, 3) + rcs(year, 3) + sex", design = subset(svy_dat, class=="Workers"))

regs_more = NULL
for(i in 1:10){
  cbind(exp(more_adj[[i]]$coefficients[2:3]), exp(confint(more_adj[[i]])[2:3,])) -> bind
  rbind(regs_more, cbind(bind, rep(names(dat)[124:133][i],2))) -> regs_more
}

#full adj
full_adj <- mysvy(dat, 124:133, "~race + rcs(age, 3) + rcs(year, 3) + sex + educ + region", design = subset(svy_dat, class=="Workers"))

regs_full = NULL
for(i in 1:10){
  cbind(exp(full_adj[[i]]$coefficients[2:3]), exp(confint(full_adj[[i]])[2:3,])) -> bind
  rbind(regs_full, cbind(bind, rep(names(dat)[124:133][i],2))) -> regs_full
}

#bind together
binded <- rbind(cbind(regs_less, rep("Age+year", 20)), cbind(regs_more, rep("Age+year+gender", 20)), cbind(regs_full, rep("Age+year+gender+educ+region", 20)))

#format
binded %>%
  as.data.frame() %>%
  mutate(Race=factor(rep(c("Black", "Other"), 30), levels=c("Black", "Other")),
         V5=factor(V5, levels=c("Age+year", "Age+year+gender", "Age+year+gender+educ+region")),
         `Prevalence ratio`=as.numeric(V1),
         Lower=as.numeric(`2.5 %`),
         Upper=as.numeric(`97.5 %`)) -> binded

#plot
ggplot(binded, aes(y=Race, x=`Prevalence ratio`, xmin=Lower, xmax=Upper, group=rev(V5), shape=V5, color=V5)) +
  geom_point(position=position_dodge(width = 0.5)) +
  geom_errorbar(position=position_dodge(width = 0.5)) + 
  geom_vline(xintercept=1, lty=2, col='darkgrey') +
  facet_grid(V4~.) +
  scale_x_continuous(trans="log", limits=c(0.3, 2.5), breaks=c(0.3, 1, 1.7, 2.4)) +
  theme_light() + 
  scale_color_manual(values=brewer.pal(8, "Blues")[c(4,6,8)]) +
  theme(strip.background = element_rect(fill=NA, color='grey'), strip.text = element_text(colour = "black"), legend.position='bottom', legend.title=element_blank())
```

### Gender interaction

```{r warning=FALSE, message=FALSE, fig.height=12, fig.width=12}
#less adjusted men
less_adj <- mysvy(dat, 124:133, "~race*sex + rcs(age, 3) + rcs(year, 3)", design = subset(svy_dat, class=="Workers"))

regs_less_men = NULL
for(i in 1:10){
  cbind(exp(less_adj[[i]]$coefficients[2:3]), exp(confint(less_adj[[i]])[2:3,])) -> bind
  rbind(regs_less_men, cbind(bind, rep(names(dat)[124:133][i],2))) -> regs_less_men
}

#less adjusted women
less_adj <- mysvy(dat, 124:133, "~race*relevel(sex, 'female') + rcs(age, 3) + rcs(year, 3)", design = subset(svy_dat, class=="Workers"))

regs_less_women = NULL
for(i in 1:10){
  cbind(exp(less_adj[[i]]$coefficients[2:3]), exp(confint(less_adj[[i]])[2:3,])) -> bind
  rbind(regs_less_women, cbind(bind, rep(names(dat)[124:133][i],2))) -> regs_less_women
}

#fully adjusted men
full_adj <- mysvy(dat, 124:133, "~race*sex + rcs(age, 3) + rcs(year, 3) + region + educ", design = subset(svy_dat, class=="Workers"))

regs_full_men = NULL
for(i in 1:10){
  cbind(exp(full_adj[[i]]$coefficients[2:3]), exp(confint(full_adj[[i]])[2:3,])) -> bind
  rbind(regs_full_men, cbind(bind, rep(names(dat)[124:133][i],2))) -> regs_full_men
}

#fully adjusted women
full_adj <- mysvy(dat, 124:133, "~race*relevel(sex, 'female') + rcs(age, 3) + rcs(year, 3) + region + educ", design = subset(svy_dat, class=="Workers"))

regs_full_women = NULL
for(i in 1:10){
  cbind(exp(full_adj[[i]]$coefficients[2:3]), exp(confint(full_adj[[i]])[2:3,])) -> bind
  rbind(regs_full_women, cbind(bind, rep(names(dat)[124:133][i],2))) -> regs_full_women
}

#bind together
binded <- rbind(cbind(regs_less_men, rep("Age+year", 20)), cbind(regs_less_women, rep("Age+year", 20)), 
                cbind(regs_full_men, rep("Age+year+educ+region", 20)), cbind(regs_full_women, rep("Age+year+educ+region", 20)))

#format
binded %>%
  as.data.frame() %>%
  mutate(Race=factor(rep(c("Black", "Other"), 40), levels=c("Black", "Other")),
         V5=factor(V5, levels=c("Age+year", "Age+year+educ+region")),
         Gender=rep(c(rep("Men", 20), rep("Women", 20)), 2),
         `Prevalence ratio`=as.numeric(V1),
         Lower=as.numeric(`2.5 %`),
         Upper=as.numeric(`97.5 %`)) -> binded

#plot
ggplot(binded, aes(y=Race, x=`Prevalence ratio`, xmin=Lower, xmax=Upper, group=rev(V5), shape=V5, color=V5)) +
  geom_point(position=position_dodge(width = 0.5)) +
  geom_errorbar(position=position_dodge(width = 0.5)) + 
  geom_vline(xintercept=1, lty=2, col='darkgrey') +
  facet_grid(V4~Gender) +
  scale_x_continuous(trans="log", limits=c(0.08, 3.26), breaks=c(0.25, 1, 1.75, 2.5, 3.25)) +
  theme_light() + 
  scale_color_manual(values=brewer.pal(8, "Blues")[c(4,6,8)]) +
  theme(strip.background = element_rect(fill=NA, color='grey'), strip.text = element_text(colour = "black"), legend.position='bottom', legend.title=element_blank())
```